System.register(["./json-asset-1f2be75e.js","./view-368b93a3.js","./texture-buffer-pool-4d3e5972.js","./transform-utils-ca30a5c5.js","./create-mesh-87c3403d.js","./mesh-03a92ddc.js","./mesh-renderer-251b554d.js","./skeleton-6271b1fe.js"],(function(t){"use strict";var e,i,n,r,o,s,a,u,l,h,c,f,p,d,_,m,g,y,v,b,k,w,S,T,A,x,M,I,O,B,N,C,P,j,z,D,E,L,R,U,F,H,G,K,V,W,J,q,X,Y,Z,Q,$,tt,et,it,nt,rt,ot,st,at,ut,lt,ht,ct,ft,pt,dt,_t,mt,gt,yt,vt,bt,kt,wt,St,Tt,At,xt,Mt,It,Ot;return{setters:[function(t){e=t.dJ,i=t.ga,n=t.gb,r=t.gc,o=t.cc,s=t.cS,a=t.l,u=t.eL,l=t.cJ,h=t.c5,c=t.ee,f=t.e1,p=t.ef,d=t.et,_=t.ej,m=t.eb,g=t.gd,y=t.eg,v=t.eh,b=t.fT,k=t.ge,w=t.ec,S=t.dN,T=t.cj,A=t.fX,x=t.fY,M=t.fZ,I=t.gf,O=t.cr,B=t.cR,N=t.c9,C=t.bT,P=t.L,j=t.N,z=t.e8,D=t.b4,E=t.F,L=t.x,R=t.aq,U=t.z,F=t.G,H=t.gg,G=t.t,K=t.gh,V=t.gi,W=t.gj,J=t.bU,q=t.gk,X=t.dG,Y=t.g9,Z=t.aH,Q=t.b3,$=t.dq,tt=t.d6,et=t.dm,it=t.gl,nt=t.fI,rt=t.gm,ot=t.c3,st=t.gn,at=t.am,ut=t.T},function(t){lt=t.L,ht=t.h,ct=t.D,ft=t.k,pt=t.n,dt=t.l,_t=t.M},function(t){mt=t.T},function(t){gt=t.p,yt=t.u,vt=t.r,bt=t.t,kt=t.q,wt=t.j,St=t.k},function(t){Tt=t.r,At=t.c},function(t){xt=t.M},function(t){Mt=t.M,It=t.a},function(t){Ot=t.S}],execute:function(){var Bt,Nt,Ct,Pt,jt,zt,Dt,Et,Lt,Rt,Ut,Ft,Ht,Gt,Kt,Vt,Wt,Jt,qt,Xt,Yt,Zt=Object.freeze({__proto__:null,find:e,toPPM:function(t,e,i){return"P3 "+e+" "+i+" 255\n"+t.filter((function(t,e){return e%4<3})).toString()+"\n"},readMesh:Tt,createMesh:At,readBuffer:i,writeBuffer:n,mapBuffer:r});function Qt(t,e){var i=t.sharedMaterials.length;if(i!==e.sharedMaterials.length)return!1;for(var n=0;n<i;n++)if(t.getRenderMaterial(n)!==e.getRenderMaterial(n))return!1;return!0}t("u",Zt),t("B",function(){function t(){}return t.batchStaticModel=function(t,e){var i=t.getComponentsInChildren(Mt);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var n=1;n<i.length;n++){if(!i[0].mesh.validateMergingMesh(i[n].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1;if(!Qt(i[0],i[n]))return console.error("the materials of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1}var r=new xt,s=new o,a=new o;t.getWorldMatrix(a),o.invert(a,a);for(var u=0;u<i.length;u++){var l=i[u];l.node.getWorldMatrix(s),o.multiply(s,a,s),r.merge(i[u].mesh,s),l.enabled=!1}var h=e.addComponent(Mt);return h.mesh=r,h.sharedMaterials=i[0].sharedMaterials,!0},t.unbatchStaticModel=function(t,e){for(var i=t.getComponentsInChildren(Mt),n=0;n<i.length;n++)i[n].enabled=!0;var r=e.getComponent(Mt);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},t}()),s(Mt.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),a.ModelComponent=Mt,u.setClassAlias(Mt,"cc.ModelComponent");var $t,te,ee,ie,ne,re,oe,se,ae,ue,le,he,ce,fe,pe,de,_e,me,ge,ye,ve,be,ke,we,Se,Te,Ae,xe,Me,Ie,Oe,Be,Ne,Ce,Pe,je,ze,De,Ee,Le,Re,Ue,Fe,He,Ge,Ke,Ve,We,Je=l({LUMINOUS_FLUX:0,LUMINANCE:1}),qe=new h,Xe=c("cc.StaticLightSettings")((Dt=function(){function t(){y(this,"_baked",Ct,this),y(this,"_editorOnly",Pt,this),y(this,"_bakeable",jt,this),y(this,"_castShadow",zt,this)}return f(t,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(t){this._editorOnly=t}},{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}}]),t}(),Ct=p((Nt=Dt).prototype,"_baked",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pt=p(Nt.prototype,"_editorOnly",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jt=p(Nt.prototype,"_bakeable",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zt=p(Nt.prototype,"_castShadow",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),p(Nt.prototype,"editorOnly",[d],Object.getOwnPropertyDescriptor(Nt.prototype,"editorOnly"),Nt.prototype),p(Nt.prototype,"bakeable",[d],Object.getOwnPropertyDescriptor(Nt.prototype,"bakeable"),Nt.prototype),p(Nt.prototype,"castShadow",[d],Object.getOwnPropertyDescriptor(Nt.prototype,"castShadow"),Nt.prototype),Bt=Nt))||Bt,Ye=t("L",(Et=c("cc.Light"),Lt=b(),Rt=b(),Ut=k(),Ft=b(),Ht=_(Xe),Et((Yt=Xt=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_color",Vt,w(e)),y(e,"_useColorTemperature",Wt,w(e)),y(e,"_colorTemperature",Jt,w(e)),y(e,"_staticSettings",qt,w(e)),e._type=lt.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=ht,e}m(e,t);var i=e.prototype;return i.onLoad=function(){this._createLight()},i.onEnable=function(){this._attachToScene()},i.onDisable=function(){this._detachFromScene()},i.onDestroy=function(){this._destroyLight()},i._createLight=function(){this._light||(this._light=a.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},i._destroyLight=function(){this._light&&(a.director.root.destroyLight(this),this._light=null)},i._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var t=this._getRenderScene();switch(this._type){case lt.DIRECTIONAL:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case lt.SPHERE:t.addSphereLight(this._light);break;case lt.SPOT:t.addSpotLight(this._light)}}},i._detachFromScene=function(){if(this._light&&this._light.scene){var t=this._light.scene;switch(this._type){case lt.DIRECTIONAL:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case lt.SPHERE:t.removeSphereLight(this._light);break;case lt.SPOT:t.removeSpotLight(this._light)}}},f(e,[{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._light&&(qe.x=t.r/255,qe.y=t.g/255,qe.z=t.b/255,this._light.color=qe)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(t){this._staticSettings=t}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}}]),e}(S),Xt.Type=lt,Xt.PhotometricTerm=Je,Vt=p((Kt=Yt).prototype,"_color",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T.WHITE.clone()}}),Wt=p(Kt.prototype,"_useColorTemperature",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jt=p(Kt.prototype,"_colorTemperature",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),qt=p(Kt.prototype,"_staticSettings",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Xe}}),p(Kt.prototype,"color",[Lt],Object.getOwnPropertyDescriptor(Kt.prototype,"color"),Kt.prototype),p(Kt.prototype,"useColorTemperature",[Rt],Object.getOwnPropertyDescriptor(Kt.prototype,"useColorTemperature"),Kt.prototype),p(Kt.prototype,"colorTemperature",[g,Ut,Ft],Object.getOwnPropertyDescriptor(Kt.prototype,"colorTemperature"),Kt.prototype),p(Kt.prototype,"staticSettings",[Ht],Object.getOwnPropertyDescriptor(Kt.prototype,"staticSettings"),Kt.prototype),Gt=Kt))||Gt)),Ze=t("D",($t=c("cc.DirectionalLight"),te=x(),ee=M(),ie=I(),ne=b(),$t(re=te(re=ee(re=A((ae=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_illuminance",se,w(e)),e._type=lt.DIRECTIONAL,e._light=null,e._lightType=ct,e}return m(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._light&&(this.illuminance=this._illuminance)},f(e,[{key:"illuminance",get:function(){return this._illuminance},set:function(t){this._illuminance=t,this._light&&(this._light.illuminance=this._illuminance)}}]),e}(Ye),se=p((oe=ae).prototype,"_illuminance",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),p(oe.prototype,"illuminance",[ie,ne],Object.getOwnPropertyDescriptor(oe.prototype,"illuminance"),oe.prototype),re=oe))||re)||re)||re)||re)),Qe=t("S",(ue=c("cc.SphereLight"),le=x(),he=M(),ce=I(),fe=b(),pe=I(),de=b(),_e=_(Je),me=b(),ge=b(),ye=b(),ue(ve=le(ve=he(ve=A((Ae=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_size",ke,w(e)),y(e,"_luminance",we,w(e)),y(e,"_term",Se,w(e)),y(e,"_range",Te,w(e)),e._type=lt.SPHERE,e._light=null,e._lightType=ft,e}return m(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range)},f(e,[{key:"luminousFlux",get:function(){return this._luminance*pt(this._size)},set:function(t){this._luminance=t/pt(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(t){this._luminance=t,this._light&&(this._light.luminance=t)}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}}]),e}(Ye),ke=p((be=Ae).prototype,"_size",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),we=p(be.prototype,"_luminance",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/pt(.15)}}),Se=p(be.prototype,"_term",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Je.LUMINOUS_FLUX}}),Te=p(be.prototype,"_range",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),p(be.prototype,"luminousFlux",[ce,fe],Object.getOwnPropertyDescriptor(be.prototype,"luminousFlux"),be.prototype),p(be.prototype,"luminance",[pe,de],Object.getOwnPropertyDescriptor(be.prototype,"luminance"),be.prototype),p(be.prototype,"term",[_e,me],Object.getOwnPropertyDescriptor(be.prototype,"term"),be.prototype),p(be.prototype,"size",[ge],Object.getOwnPropertyDescriptor(be.prototype,"size"),be.prototype),p(be.prototype,"range",[ye],Object.getOwnPropertyDescriptor(be.prototype,"range"),be.prototype),ve=be))||ve)||ve)||ve)||ve)),$e=t("a",(xe=c("cc.SpotLight"),Me=x(),Ie=M(),Oe=I(),Be=b(),Ne=I(),Ce=b(),Pe=_(Je),je=b(),ze=b(),De=b(),Ee=k(),Le=b(),xe(Re=Me(Re=Ie(Re=A((We=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_size",Fe,w(e)),y(e,"_luminance",He,w(e)),y(e,"_term",Ge,w(e)),y(e,"_range",Ke,w(e)),y(e,"_spotAngle",Ve,w(e)),e._type=lt.SPOT,e._light=null,e._lightType=dt,e}return m(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle)},f(e,[{key:"luminousFlux",get:function(){return this._luminance*pt(this._size)},set:function(t){this._luminance=t/pt(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(t){this._luminance=t,this._light&&(this._light.luminance=t)}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._spotAngle=t,this._light&&(this._light.spotAngle=O(t))}}]),e}(Ye),Fe=p((Ue=We).prototype,"_size",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),He=p(Ue.prototype,"_luminance",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/pt(.15)}}),Ge=p(Ue.prototype,"_term",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Je.LUMINOUS_FLUX}}),Ke=p(Ue.prototype,"_range",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ve=p(Ue.prototype,"_spotAngle",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),p(Ue.prototype,"luminousFlux",[Oe,Be],Object.getOwnPropertyDescriptor(Ue.prototype,"luminousFlux"),Ue.prototype),p(Ue.prototype,"luminance",[Ne,Ce],Object.getOwnPropertyDescriptor(Ue.prototype,"luminance"),Ue.prototype),p(Ue.prototype,"term",[Pe,je],Object.getOwnPropertyDescriptor(Ue.prototype,"term"),Ue.prototype),p(Ue.prototype,"size",[ze],Object.getOwnPropertyDescriptor(Ue.prototype,"size"),Ue.prototype),p(Ue.prototype,"range",[De],Object.getOwnPropertyDescriptor(Ue.prototype,"range"),Ue.prototype),p(Ue.prototype,"spotAngle",[g,Ee,Le],Object.getOwnPropertyDescriptor(Ue.prototype,"spotAngle"),Ue.prototype),Re=Ue))||Re)||Re)||Re)||Re));a.LightComponent=Ye,u.setClassAlias(Ye,"cc.LightComponent"),a.DirectionalLightComponent=Ze,u.setClassAlias(Ze,"cc.DirectionalLightComponent"),a.SphereLightComponent=Qe,u.setClassAlias(Qe,"cc.SphereLightComponent"),a.SpotLightComponent=$e,u.setClassAlias($e,"cc.SpotLightComponent"),B($e.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),B(Qe.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),B(Ye.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var ti=function(t,e,i){t[e+0]=i.m00,t[e+1]=i.m01,t[e+2]=i.m02,t[e+3]=i.m12,t[e+4]=i.m04,t[e+5]=i.m05,t[e+6]=i.m06,t[e+7]=i.m13,t[e+8]=i.m08,t[e+9]=i.m09,t[e+10]=i.m10,t[e+11]=i.m14};function ei(t,e){var i=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*i,t)/12)}new N,new N,new h,new N,new h;var ii=C([P.POINT,P.POINT,P.NONE,j.CLAMP,j.CLAMP,j.CLAMP]),ni=new h,ri=new h,oi=new h,si=new h,ai=new o,ui=new o,li=new z,hi=Number.MAX_SAFE_INTEGER,ci=function(){function t(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var e=function(t){return t.hasFeature(E.TEXTURE_FLOAT)?L.RGBA32F:L.RGBA8}(this._device);this._formatSize=D[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new mt(t),this._pool.initialize({format:e,roundUpFn:ei}),this._customPool=new mt(t),this._customPool.initialize({format:e,roundUpFn:ei})}var e=t.prototype;return e.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},e.registerCustomTextureLayouts=function(t){for(var e=0;e<t.length;e++)for(var i=t[e],n=this._customPool.createChunk(i.textureLength),r=0;r<i.contents.length;r++){var o=i.contents[r],s=o.skeleton;this._chunkIdxMap.set(s,n);for(var a=0;a<o.clips.length;a++){var u=o.clips[a];this._chunkIdxMap.set(s^u,n)}}},e.getDefaultPoseTexture=function(t,e,i){var n=0^t.hash,r=this._textureBuffers.get(n)||null;if(r&&r.bounds.has(e.hash))return r.refCount++,r;var s=t.joints,a=t.bindposes,u=null,l=!1,c=s.length;if(r)r.refCount++;else{var f=12*c,p=this._chunkIdxMap.get(n),d=void 0!==p?this._customPool.alloc(f*Float32Array.BYTES_PER_ELEMENT,p):this._pool.alloc(f*Float32Array.BYTES_PER_ELEMENT);if(!d)return r;r={pixelOffset:d.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:d},u=new Float32Array(f),l=!0}h.set(oi,hi,hi,hi),h.set(si,-hi,-hi,-hi);for(var _=e.getBoneSpaceBounds(t),m=0,g=0;m<c;m++,g+=12){var y=i.getChildByPath(s[m]),v=y?gt(y,i,ai):t.inverseBindposes[m],b=_[m];b&&(z.transform(li,b,v),li.getBoundary(ni,ri),h.min(oi,oi,ni),h.max(si,si,ri)),l&&(y&&o.multiply(v,v,a[m]),ti(u,g,y?v:o.IDENTITY))}var k=[new z];return r.bounds.set(e.hash,k),z.fromPoints(k[0],oi,si),l&&(this._pool.update(r.handle,u.buffer),this._textureBuffers.set(n,r)),r},e.getSequencePoseTexture=function(t,e,i,n){var r=t.hash^e.hash,s=this._textureBuffers.get(r)||null;if(s&&s.bounds.has(i.hash))return s.refCount++,s;var a=t.joints,u=t.bindposes,l=yt.getOrExtract(e).frames,c=null,f=!1,p=a.length;if(s)s.refCount++;else{var d=12*p*l,_=this._chunkIdxMap.get(r),m=void 0!==_?this._customPool.alloc(d*Float32Array.BYTES_PER_ELEMENT,_):this._pool.alloc(d*Float32Array.BYTES_PER_ELEMENT);if(!m)return null;var g=this._createAnimInfos(t,e,n);s={pixelOffset:m.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:m,animInfos:g},c=new Float32Array(d),f=!0}var y=i.getBoneSpaceBounds(t),v=[];s.bounds.set(i.hash,v);for(var b=0;b<l;b++)v.push(new z(hi,hi,hi,-hi,-hi,-hi));for(var k=0,w=0;k<l;k++){for(var S=v[k],T=0;T<p;T++,w+=12){var A=s.animInfos[T],x=A.curveData,M=A.downstream,I=A.bindposeIdx,O=A.bindposeCorrection,B=void 0,N=!0;x&&M?B=o.multiply(ai,x[k],M):x?B=x[k]:M?B=M:(B=t.inverseBindposes[I],N=!1);var C=y[T];if(C){var P=O?o.multiply(ui,B,O):B;z.transform(li,C,P),li.getBoundary(ni,ri),h.min(S.center,S.center,ni),h.max(S.halfExtents,S.halfExtents,ri)}f&&(N&&o.multiply(ai,B,u[I]),ti(c,w,N?ai:o.IDENTITY))}z.fromPoints(S,S.center,S.halfExtents)}return f&&(this._pool.update(s.handle,c.buffer),this._textureBuffers.set(r,s)),s},e.releaseHandle=function(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){var e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}},e.releaseSkeleton=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.skeletonHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e.releaseAnimationClip=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.clipHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e._createAnimInfos=function(t,e,i){for(var n=[],r=t.joints,s=t.bindposes,a=r.length,u=yt.getOrExtract(e),l=0;l<a;l++){for(var h=r[l],c=u.joints[h],f=i.getChildByPath(h),p=void 0,d=void 0;!c;){var _=h.lastIndexOf("/");if(h=h.substring(0,_),c=u.joints[h],f?(p||(p=new o),o.fromRTS(ai,f.rotation,f.position,f.scale),o.multiply(p,ai,p),f=f.parent):d=h,_<0)break}var m=l,g=void 0;if(void 0!==d&&c){m=l-1;for(var y=0;y<a;y++)if(r[y]===d){m=y,g=new o,o.multiply(g,s[y],t.inverseBindposes[l]);break}}n.push({curveData:c&&c.transforms,downstream:p,bindposeIdx:m,bindposeCorrection:g})}return n},f(t,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),t}(),fi=function(){function t(t){this._pool=new Map,this._device=void 0,this._device=t}var e=t.prototype;return e.getData=function(t){void 0===t&&(t="-1");var e=this._pool.get(t);if(e)return e;var i=this._device.createBuffer(new R(U.UNIFORM|U.TRANSFER_DST,F.HOST|F.DEVICE,H.SIZE,H.SIZE)),n=new Float32Array([0,0,0,0]);i.update(n);var r={buffer:i,data:n,dirty:!1};return this._setAnimInfoDirty(r,!1),this._pool.set(t,r),r},e.destroy=function(t){var e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))},e._setAnimInfoDirty=function(t,e){t.dirty=e},e.switchClip=function(t){return t.data[0]=0,t.buffer.update(t.data),this._setAnimInfoDirty(t,!1),t},e.clear=function(){for(var t,e=G(this._pool.values());!(t=e()).done;)t.value.buffer.destroy();this._pool.clear()},t}(),pi=function(){function t(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new ci(t),this.jointAnimationInfo=new fi(t)}var e=t.prototype;return e.releaseSkeleton=function(t){this.jointTexturePool.releaseSkeleton(t)},e.releaseAnimationClip=function(t){this.jointTexturePool.releaseAnimationClip(t)},e.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},t}();a.internal.DataPoolManager=pi;var di=[{name:"CC_USE_SKINNING",value:!0}];function _i(t,e,i,n){for(var r=0;r<i.length;r++){for(var o=i[r],s=-1,a=0;a<o.length;a++)if(o[a]===n){s=a;break}s>=0&&(e.push(r),t.push(s))}}var mi,gi,yi,vi,bi,ki,wi,Si,Ti,Ai,xi,Mi,Ii,Oi,Bi,Ni,Ci,Pi,ji,zi,Di,Ei,Li,Ri,Ui,Fi,Hi,Gi,Ki,Vi,Wi,Ji,qi,Xi,Yi,Zi,Qi,$i,tn,en,nn,rn,on,sn,an,un=new h,ln=new h,hn=new h,cn=new h,fn=new o,pn=new z,dn=function(t){function e(){var e;return(e=t.call(this)||this).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=_t.SKINNING,e}m(e,t);var i=e.prototype;return i._init=function(){},i.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}t.prototype.destroy.call(this)},i.bindSkeleton=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null);for(var n=0;n<this._joints.length;n++)vt(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,t&&e&&i){this.transform=e;var r=i.getBoneSpaceBounds(t),o=i.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=i.jointBufferIndices;for(var s=0;s<t.joints.length;s++){var a=r[s],u=e.getChildByPath(t.joints[s]);if(a&&u){var l=bt(u,e),h=t.bindposes[s],c=[],f=[];o?_i(c,f,o,s):(c.push(s),f.push(0)),this._joints.push({indices:c,buffers:f,bound:a,target:u,bindpose:h,transform:l})}}}},i.updateTransform=function(t){var e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdated=!0),h.set(un,1/0,1/0,1/0),h.set(ln,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.bound,o=n.transform,s=kt(o,t);z.transform(pn,r,s),pn.getBoundary(hn,cn),h.min(un,un,hn),h.max(ln,ln,cn)}var a=this._worldBounds;this._modelBounds&&a&&(z.fromPoints(this._modelBounds,un,ln),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds),this._updateNativeBounds())},i.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.indices,s=n.buffers,a=n.transform,u=n.bindpose;o.multiply(fn,a.world,u);for(var l=0;l<s.length;l++)ti(this._dataArray[s[l]],12*r[l],fn)}for(var h=0;h<this._buffers.length;h++)this._buffers[h].update(this._dataArray[h]);return!0},i.initSubModel=function(e,i,n){var r=i.vertexBuffers,o=i.iaInfo;o.vertexBuffers=i.jointMappedBuffers,t.prototype.initSubModel.call(this,e,i,n),o.vertexBuffers=r},i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?di.concat(i):di},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._buffers[this._bufferIndices[e]];n&&i.bindBuffer(K.BINDING,n)},i._ensureEnoughBuffers=function(t){for(var e=0;e<t;e++)this._buffers[e]||(this._buffers[e]=this._device.createBuffer(new R(U.UNIFORM|U.TRANSFER_DST,F.HOST|F.DEVICE,K.SIZE,K.SIZE))),this._dataArray[e]||(this._dataArray[e]=new Float32Array(K.COUNT))},e}(It),_n=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],mn=function(t){function e(){var e;(e=t.call(this)||this).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=_t.BAKED_SKINNING,e._dataPoolManager=a.director.root.dataPoolManager;var i=new Float32Array(4),n=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:i,animInfo:n,texture:null,boundsInfo:null},e}m(e,t);var i=e.prototype;return i._init=function(){},i.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),t.prototype.destroy.call(this)},i.bindSkeleton=function(t,e,i){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),this._skeleton=t,this._mesh=i,t&&e&&i){this.transform=e;var n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new R(U.UNIFORM|U.TRANSFER_DST,F.HOST|F.DEVICE,V.SIZE,V.SIZE)))}},i.updateTransform=function(e){if(t.prototype.updateTransform.call(this,e),this.uploadedAnim){var i=this._jointsMedium,n=i.animInfo,r=i.boundsInfo[n.data[0]],o=this._worldBounds;if(o&&r){var s=this.transform;r.transform(s._mat,s._pos,s._rot,s._scale,o)}}},i.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);var i=this._jointsMedium.animInfo,n=this._instAnimInfoIdx;return n>=0?this.instancedAttributes.views[n][0]=i.data[0]:i.dirty&&(i.buffer.update(i.data),i.dirty=!1),!0},i._applyNativeJointMedium=function(){},i._updateModelBounds=function(t){this._modelBounds=t},i.uploadAnimation=function(t){if(this._skeleton&&this._mesh&&this.uploadedAnim!==t){this.uploadedAnim=t;var e=this._dataPoolManager,i=null;t?(i=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(i=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(i&&i.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(i),this._applyNativeJointMedium()}},i._applyJointTexture=function(t){void 0===t&&(t=null);var e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,t){var i=this._jointsMedium,n=i.buffer,r=i.jointTextureInfo;r[0]=t.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=t.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),n&&n.update(r);for(var o=t.handle.texture,s=0;s<this._subModels.length;++s)this._subModels[s].descriptorSet.bindTexture(W,o)}},i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?i.concat(_n):_n},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._jointsMedium,r=n.buffer,o=n.texture,s=n.animInfo;if(i.bindBuffer(V.BINDING,r),i.bindBuffer(H.BINDING,s.buffer),o){var a=J.getSampler(this._device,ii);i.bindTexture(W,o.handle.texture),i.bindSampler(W,a)}},i._setInstAnimInfoIdx=function(t){this._instAnimInfoIdx=t},i._updateInstancedAttributes=function(e,i){t.prototype._updateInstancedAttributes.call(this,e,i),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(q)),this.updateInstancedJointTextureInfo()},i.updateInstancedJointTextureInfo=function(){var t=this._jointsMedium,e=t.jointTextureInfo,i=t.animInfo,n=this._instAnimInfoIdx;if(n>=0){var r=this.instancedAttributes.views[n];r[0]=i.data[0],r[1]=e[1],r[2]=e[2]}},e}(It),gn=t("b",(mi=c("cc.SkinnedMeshRenderer"),gi=x(),yi=Y(100),vi=M(),bi=_(Ot),ki=_(X),wi=_(Ot),Si=_(X),Ti=b(),mi(Ai=gi(Ai=yi(Ai=A(Ai=vi((Oi=function(t){function e(){var e;return e=t.call(this)||this,y(e,"_skeleton",Mi,w(e)),y(e,"_skinningRoot",Ii,w(e)),e._clip=null,e._modelType=mn,e}m(e,t);var i=e.prototype;return i.__preload=function(){this._updateModelType()},i.uploadAnimation=function(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)},i.setUseBakedAnimation=function(t,e){void 0===t&&(t=!0),void 0===e&&(e=!1);var i=t?mn:dn;(e||this._modelType!==i)&&(this._modelType=i,this._model&&(a.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},i.setMaterial=function(e,i){t.prototype.setMaterial.call(this,e,i),this._modelType===dn&&this.getMaterialInstance(i)},i._updateModelParams=function(){this._update(),t.prototype._updateModelParams.call(this)},i._updateModelType=function(){if(this._skinningRoot){var t=this._skinningRoot.getComponent("cc.SkeletalAnimation");t?this.setUseBakedAnimation(t.useBakedAnimation):this.setUseBakedAnimation(!1)}},i._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},f(e,[{key:"skeleton",get:function(){return this._skeleton},set:function(t){t!==this._skeleton&&(this._skeleton=t,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(t){t!==this._skinningRoot&&(this._skinningRoot=t,this._updateModelType(),this._update())}},{key:"model",get:function(){return this._model}}]),e}(Mt),Mi=p((xi=Oi).prototype,"_skeleton",[bi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ii=p(xi.prototype,"_skinningRoot",[ki],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),p(xi.prototype,"skeleton",[wi],Object.getOwnPropertyDescriptor(xi.prototype,"skeleton"),xi.prototype),p(xi.prototype,"skinningRoot",[Si,Ti],Object.getOwnPropertyDescriptor(xi.prototype,"skinningRoot"),xi.prototype),Ai=xi))||Ai)||Ai)||Ai)||Ai)||Ai)),yn=new Z(Q.ATTR_BATCH_ID,L.R32F),vn=new Z(Q.ATTR_BATCH_UV,L.RG32F),bn=D[yn.format].size+D[vn.format].size,kn=t("d",(Bi=c("cc.SkinnedMeshUnit"),Ni=_(xt),Ci=_(Ot),Pi=_($),ji=_(gn),Bi((Gi=function(){function t(){y(this,"mesh",Ei,this),y(this,"skeleton",Li,this),y(this,"material",Ri,this),y(this,"_localTransform",Ui,this),y(this,"_offset",Fi,this),y(this,"_size",Hi,this)}return f(t,[{key:"offset",get:function(){return this._offset},set:function(t){ot.copy(this._offset,t)}},{key:"size",get:function(){return this._size},set:function(t){ot.copy(this._size,t)}},{key:"copyFrom",get:function(){return null},set:function(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&gt(t.node,t.skinningRoot,this._localTransform))}}]),t}(),Ei=p((Di=Gi).prototype,"mesh",[Ni],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Li=p(Di.prototype,"skeleton",[Ci],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ri=p(Di.prototype,"material",[Pi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ui=p(Di.prototype,"_localTransform",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),Fi=p(Di.prototype,"_offset",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ot(0,0)}}),Hi=p(Di.prototype,"_size",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ot(1,1)}}),p(Di.prototype,"offset",[d],Object.getOwnPropertyDescriptor(Di.prototype,"offset"),Di.prototype),p(Di.prototype,"size",[d],Object.getOwnPropertyDescriptor(Di.prototype,"size"),Di.prototype),p(Di.prototype,"copyFrom",[ji],Object.getOwnPropertyDescriptor(Di.prototype,"copyFrom"),Di.prototype),zi=Di))||zi)),wn=new o,Sn=(new o,new h),Tn=t("c",(Ki=c("cc.SkinnedMeshBatchRenderer"),Vi=x(),Wi=Y(100),Ji=M(),qi=b(),Xi=_([tt]),Yi=b(),Zi=_([kn]),Qi=b(),$i=st(),tn=st(),Ki(en=Vi(en=Wi(en=A(en=Ji((an=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return e=t.call.apply(t,[this].concat(n))||this,y(e,"atlasSize",rn,w(e)),y(e,"batchableTextureNames",on,w(e)),y(e,"units",sn,w(e)),e._textures={},e._batchMaterial=null,e}m(e,t);var s=e.prototype;return s.onLoad=function(){t.prototype.onLoad.call(this),this.cook()},s.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),t.prototype.onDestroy.call(this)},s._onMaterialModified=function(e){this.cookMaterials(),t.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},s.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},s.cookMaterials=function(){var t=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var e=this.getMaterialInstance(0);if(e&&this._batchMaterial&&this._batchMaterial.effectAsset){e.copy(this._batchMaterial),this.resizeAtlases();for(var i=e.effectAsset.techniques[e.technique],n=function(n){var r=i.passes[n];if(!r.properties)return"continue";var o=function(i){if(r.properties[i].type>=ut.SAMPLER1D){var o=null;t.batchableTextureNames.find((function(t){return t===i}))?((o=t._textures[i])||(o=t.createTexture(i)),t.cookTextures(o,i,n)):t.units.some((function(t){return o=t.material&&t.material.getProperty(i,n)})),o&&e.setProperty(i,o,n)}else{for(var s=[],a=0;a<t.units.length;a++){var u=t.units[a];u.material&&s.push(u.material.getProperty(i.slice(0,-3),n))}e.setProperty(i,s,n)}};for(var s in r.properties)o(s)},r=0;r<i.passes.length;r++)n(r)}else console.warn("incomplete batch material!")},s.cookSkeletons=function(){if(this._skinningRoot){for(var t=[],e=[],i=0;i<this.units.length;i++){var n=this.units[i];if(n&&n.skeleton){var r=n.skeleton;o.invert(wn,n._localTransform);for(var s=function(i){var n=r.joints[i];if(t.findIndex((function(t){return t===n}))>=0)return"continue";t.push(n),e.push(o.multiply(new o,r.bindposes[i]||o.IDENTITY,wn))},a=0;a<r.joints.length;a++)s(a)}}var u=Array.from(Array(t.length).keys()).sort((function(e,i){return t[e]>t[i]?1:t[e]<t[i]?-1:0})),l=new Ot;l.joints=t.map((function(t,e,i){return i[u[e]]})),l.bindposes=e.map((function(t,e,i){return i[u[e]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=l}else console.warn("no skinning root specified!")},s.cookMeshes=function(){for(var t=this,e=!1,s=0;s<this.units.length;s++)if(this.units[s].mesh){e=!0;break}if(e&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new xt;for(var a=0,u=L.UNKNOWN,l=0,c=L.UNKNOWN,f=0,p=L.UNKNOWN,d=0,_=L.UNKNOWN,m=0,g=L.UNKNOWN,y=new Array(this.units.length),v=this.units.length,b=0;b<v;b++){var k=this.units[b];k&&k.skeleton&&(y[b]=k.skeleton.joints.map((function(e){return t._skeleton.joints.findIndex((function(t){return e===t}))})))}for(var w=function(e){var s=t.units[e];if(!s||!s.mesh||!s.mesh.data)return"continue";var v=t._createUnitMesh(e,s.mesh),b=new DataView(v.data.buffer);o.inverseTranspose(wn,s._localTransform);for(var k=s.offset,w=s.size,S=function(t){var o=v.struct.vertexBundles[t];a=o.view.offset,u=L.UNKNOWN;for(var S=0;S<o.attributes.length;S++){var T=o.attributes[S];if(T.name===Q.ATTR_POSITION){u=T.format;break}a+=D[T.format].size}if(u){for(var A=i(b,u,a,o.view.length,o.view.stride),x=0;x<A.length;x+=3)h.fromArray(Sn,A,x),h.transformMat4(Sn,Sn,s._localTransform),h.toArray(A,Sn,x);n(b,A,u,a,o.view.stride)}l=o.view.offset,c=L.UNKNOWN;for(var M=0;M<o.attributes.length;M++){var I=o.attributes[M];if(I.name===Q.ATTR_NORMAL){c=I.format;break}l+=D[I.format].size}if(c){for(var O=i(b,c,l,o.view.length,o.view.stride),B=0;B<O.length;B+=3)h.fromArray(Sn,O,B),h.transformMat4Normal(Sn,Sn,wn),h.toArray(O,Sn,B);n(b,O,c,l,o.view.stride)}f=o.view.offset,p=L.UNKNOWN;for(var N=0;N<o.attributes.length;N++){var C=o.attributes[N];if(C.name===Q.ATTR_TANGENT){p=C.format;break}f+=D[C.format].size}if(p){for(var P=i(b,p,f,o.view.length,o.view.stride),j=0;j<P.length;j+=3)h.fromArray(Sn,P,j),h.transformMat4Normal(Sn,Sn,wn),h.toArray(P,Sn,j);n(b,P,p,f,o.view.stride)}d=o.view.offset,_=L.UNKNOWN;for(var z=0;z<o.attributes.length;z++){var E=o.attributes[z];if(E.name===Q.ATTR_BATCH_UV){_=E.format;break}d+=D[E.format].size}_&&r(b,(function(t,e){var i,n=0===e?"x":"y";return(t=(i=t)-Math.floor(i))*w[n]+k[n]}),_,d,o.view.length,o.view.stride,b);var R=y[e];if(!R)return"continue";m=o.view.offset,g=L.UNKNOWN;for(var U=0;U<o.attributes.length;U++){var F=o.attributes[U];if(F.name===Q.ATTR_JOINTS){g=F.format;break}m+=D[F.format].size}g&&r(b,(function(t){return R[t]}),g,m,o.view.length,o.view.stride,b)},T=0;T<v.struct.vertexBundles.length;T++)S(T);t._mesh.merge(v)},S=0;S<v;S++)w(S);this._onMeshChanged(this._mesh),this._updateModels()}},s.cookTextures=function(t,e,i){for(var n=[],r=[],o=[],s=[],u=0;u<this.units.length;u++){var l=this.units[u];if(l.material){var h=l.material.getProperty(e,i);if(h&&h.image&&h.image.data){var c=new at;c.texOffset.x=l.offset.x*this.atlasSize,c.texOffset.y=l.offset.y*this.atlasSize,c.texExtent.width=l.size.x*this.atlasSize,c.texExtent.height=l.size.y*this.atlasSize;var f=h.image.data;ArrayBuffer.isView(f)?(o.push(f),s.push(c)):(n.push(f),r.push(c))}}}var p=t.getGFXTexture(),d=a.director.root.device;o.length>0&&d.copyBuffersToTexture(o,p,s),n.length>0&&d.copyTexImagesToTexture(n,p,r)},s.createTexture=function(t){var e=new et;return e.setFilters(it.LINEAR,it.LINEAR),e.setMipFilter(it.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:nt.RGBA8888}),this._textures[t]=e,e},s.resizeAtlases=function(){for(var t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:nt.RGBA8888})},s._createUnitMesh=function(t,e){for(var n=JSON.parse(JSON.stringify(e.struct)),r={},o=0;o<e.struct.primitives.length;o++){for(var s=e.struct.primitives[o],u=0,l=L.UNKNOWN,h=0;h<s.vertexBundelIndices.length;h++){var c=e.struct.vertexBundles[s.vertexBundelIndices[h]];u=c.view.offset,l=L.UNKNOWN;for(var f=0;f<c.attributes.length;f++){var p=c.attributes[f];if(p.name===Q.ATTR_TEX_COORD){l=p.format;break}u+=D[p.format].size}if(l)break}if(void 0===r[h]){r[h]=[l,u];var d=n.vertexBundles[h];d.attributes.push(yn),d.attributes.push(vn),d.view.offset=0,d.view.length+=d.view.count*bn,d.view.stride+=bn}}for(var _=0,m=0;m<n.vertexBundles.length;m++)_+=n.vertexBundles[m].view.length;for(var g=0;g<n.primitives.length;g++){var y=n.primitives[g];y.indexView&&(y.indexView.offset=_,_+=y.indexView.length)}var v=new Uint8Array(_),b=e.data,k=new DataView(v.buffer),w=new DataView(b.buffer),S=a.sys.isLittleEndian;for(var T in r)for(var A=n.vertexBundles[T],x=e.struct.vertexBundles[T],M=r[T],I=M[0],O=M[1],B=i(w,I,O,x.view.length,x.view.stride),N=x.view,C=A.view,P=N.stride,j=C.stride,z=N.offset,E=C.offset,R=0;R<C.count;R++){var U=b.subarray(z,z+P);v.set(U,E),k.setFloat32(E+P,t),k.setFloat32(E+P+4,B[2*R],S),k.setFloat32(E+P+8,B[2*R+1],S),E+=j,z+=P}for(var F=0;F<n.primitives.length;F++){var H=e.struct.primitives[F],G=n.primitives[F];if(H.indexView&&G.indexView)for(var K=H.indexView.stride,V=G.indexView.stride,W=H.indexView.offset,J=G.indexView.offset,q=0;q<G.indexView.count;q++){var X=b.subarray(W,W+K);v.set(X,J),J+=V,W+=K}}var Y=new xt;return Y.reset({struct:n,data:v}),Y},f(e,[{key:"mesh",get:function(){return t.prototype.mesh},set:function(t){this.mesh=t}},{key:"skeleton",get:function(){return t.prototype.skeleton},set:function(t){this.skeleton=t}}]),e}(gn),rn=p((nn=an).prototype,"atlasSize",[v,qi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),on=p(nn.prototype,"batchableTextureNames",[Xi,v,Yi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sn=p(nn.prototype,"units",[Zi,v,Qi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),p(nn.prototype,"mesh",[rt,$i],Object.getOwnPropertyDescriptor(nn.prototype,"mesh"),nn.prototype),p(nn.prototype,"skeleton",[rt,tn],Object.getOwnPropertyDescriptor(nn.prototype,"skeleton"),nn.prototype),en=nn))||en)||en)||en)||en)||en));a.SkinningModelComponent=gn,u.setClassAlias(gn,"cc.SkinningModelComponent"),a.SkinningModelUnit=kn,u.setClassAlias(kn,"cc.SkinningModelUnit"),a.BatchedSkinningModelComponent=Tn,u.setClassAlias(Tn,"cc.BatchedSkinningModelComponent");var An,xn,Mn,In,On,Bn,Nn,Cn,Pn,jn,zn,Dn,En,Ln,Rn,Un,Fn,Hn,Gn,Kn,Vn=new o,Wn=new o,Jn=t("e",function(t){function e(e,i){var n;return void 0===i&&(i=""),(n=t.call(this,e,i)||this)._frames=1,n._bakedDuration=0,n._animInfo=null,n._sockets=[],n._animInfoMgr=void 0,n._comps=[],n._parent=null,n._curvesInited=!1,n._animInfoMgr=a.director.root.dataPoolManager.jointAnimationInfo,n}m(e,t);var i=e.prototype;return i.initialize=function(e){if(!this._curveLoaded){this._comps.length=0;for(var i=e.getComponentsInChildren(gn),n=0;n<i.length;++n){var r=i[n];r.skinningRoot===e&&this._comps.push(r)}this._parent=e.getComponent("cc.SkeletalAnimation");var o=this._parent.useBakedAnimation;this._doNotCreateEval=o,t.prototype.initialize.call(this,e),this._curvesInited=!o;var s=yt.getOrExtract(this.clip),a=s.frames,u=s.samples;this._frames=a-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/u}},i.onPlay=function(){if(t.prototype.onPlay.call(this),this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this.clip);for(var e=0;e<this._comps.length;++e)this._comps[e].uploadAnimation(this.clip)}else this._sampleCurves=t.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,t.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0)},i.rebuildSocketCurves=function(t){if(this._sockets.length=0,this._targetNode)for(var e=this._targetNode,i=0;i<t.length;++i){var n=t[i],r=e.getChildByPath(n.path);if(n.target){for(var s=yt.getOrExtract(this.clip),a=n.path,u=s.joints[a],l=r,c=void 0;!u;){var f=a.lastIndexOf("/");if(a=a.substring(0,f),u=s.joints[a],l&&(c||(c=o.identity(Wn)),o.fromRTS(Vn,l.rotation,l.position,l.scale),o.multiply(c,Vn,c),l=l.parent),f<0)break}for(var p=u&&u.transforms,d=s.frames,_=[],m=0;m<d;m++){var g;g=p&&c?o.multiply(Vn,p[m],c):p?p[m]:c||new o;var y={pos:new h,rot:new N,scale:new h};o.toRTS(g,y.rot,y.pos,y.scale),_.push(y)}this._sockets.push({target:n.target,frames:_})}}},i._setAnimInfoDirty=function(t,e){t.dirty=e},i._sampleCurvesBaked=function(t){var e=t/this.duration,i=this._animInfo,n=e*this._frames+.5|0;if(n!==i.data[0]){i.data[0]=n,this._setAnimInfoDirty(i,!0);for(var r=0;r<this._sockets.length;++r){var o=this._sockets[r],s=o.target,a=o.frames[n],u=a.pos,l=a.rot,h=a.scale;s.setRTS(l,u,h)}}},e}(wt)),qn=t("f",(An=c("cc.SkeletalAnimation.Socket"),xn=_(X),An((On=p((In=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),y(this,"path",On,this),y(this,"target",Bn,this),this.path=t,this.target=e}).prototype,"path",[v,d],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Bn=p(In.prototype,"target",[xn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mn=In))||Mn));u.setClassAlias(qn,"cc.SkeletalAnimationComponent.Socket");var Xn=new o,Yn=new o;function Zn(t,e,i){void 0===e&&(e=""),void 0===i&&(i=[]);for(var n=0;n<t.children.length;n++){var r=t.children[n];if(r){var o=e?e+"/"+r.name:r.name;i.push(o),Zn(r,o,i)}}return i}var Qn=t("g",(Nn=c("cc.SkeletalAnimation"),Cn=x(),Pn=Y(99),jn=M(),zn=_([qn]),Dn=b(),En=b(),Ln=_([qn]),Nn(Rn=Cn(Rn=Pn(Rn=A(Rn=jn((Kn=Gn=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return e=t.call.apply(t,[this].concat(n))||this,y(e,"_useBakedAnimation",Fn,w(e)),y(e,"_sockets",Hn,w(e)),e}m(e,t);var i=e.prototype;return i.onDestroy=function(){t.prototype.onDestroy.call(this),a.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),a.director.getAnimationManager().removeSockets(this.node,this._sockets)},i.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,t.prototype.start.call(this)},i.querySockets=function(){var t=this._defaultClip&&Object.keys(yt.getOrExtract(this._defaultClip).joints).sort().reduce((function(t,e){return e.startsWith(t[t.length-1])||t.push(e),t}),[])||[];if(!t.length)return["please specify a valid default animation clip first"];for(var e=[],i=0;i<t.length;i++){var n=t[i],r=this.node.getChildByPath(n);r&&(e.push(n),Zn(r,n,e))}return e},i.rebuildSocketAnimations=function(){for(var t,e=G(this._sockets);!(t=e()).done;){var i=t.value,n=this.node.getChildByPath(i.path),r=i.target;n&&r&&(r.name=i.path.substring(i.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,gt(n,this.node,Xn),o.fromRTS(Yn,r.rotation,r.position,r.scale),o.equals(Yn,Xn)||(r.matrix=Xn))}for(var s=0,a=Object.keys(this._nameToState);s<a.length;s++){var u=a[s];this._nameToState[u].rebuildSocketCurves(this._sockets)}},i.createSocket=function(t){var e=this._sockets.find((function(e){return e.path===t}));if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var i=new X;return i.parent=this.node,this._sockets.push(new qn(t,i)),this.rebuildSocketAnimations(),i},i._createState=function(t,e){return new Jn(t,e)},i._doCreateState=function(e,i){var n=t.prototype._doCreateState.call(this,e,i);return n.rebuildSocketCurves(this._sockets),n},f(e,[{key:"sockets",get:function(){return this._sockets},set:function(t){if(!this._useBakedAnimation){var e=a.director.getAnimationManager();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(t){this._useBakedAnimation=t;for(var e=this.node.getComponentsInChildren(gn),i=0;i<e.length;++i){var n=e[i];n.skinningRoot===this.node&&n.setUseBakedAnimation(this._useBakedAnimation,!0)}this._useBakedAnimation?a.director.getAnimationManager().removeSockets(this.node,this._sockets):a.director.getAnimationManager().addSockets(this.node,this._sockets)}}]),e}(St),Gn.Socket=qn,p((Un=Kn).prototype,"sockets",[zn,Dn],Object.getOwnPropertyDescriptor(Un.prototype,"sockets"),Un.prototype),p(Un.prototype,"useBakedAnimation",[En],Object.getOwnPropertyDescriptor(Un.prototype,"useBakedAnimation"),Un.prototype),Fn=p(Un.prototype,"_useBakedAnimation",[v],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hn=p(Un.prototype,"_sockets",[Ln],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rn=Un))||Rn)||Rn)||Rn)||Rn)||Rn));a.SkeletalAnimationComponent=Qn,u.setClassAlias(Qn,"cc.SkeletalAnimationComponent"),a.utils=Zt}}}));
