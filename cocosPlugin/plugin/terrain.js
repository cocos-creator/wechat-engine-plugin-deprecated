System.register(["./json-asset-1f2be75e.js","./index-a996f499.js","./view-368b93a3.js","./texture-buffer-pool-4d3e5972.js","./deprecated-c0e66301.js","./camera-component-4c08f67b.js","./renderable-component-da5e0106.js","./transform-utils-ca30a5c5.js","./terrain-asset-55067aad.js"],(function(t){"use strict";var e,i,r,n,a,s,l,h,o,u,_,f,c,g,p,d,y,b,M,v,w,m,S,z,k,C,A,x,I,E,L,R,N,T,B,P,O,U,H,D,V,X,F,j,W,G,Y,q,K,Z,$,J,Q,tt,et,it;return{setters:[function(t){e=t.co,i=t.c5,r=t.ee,n=t.e1,a=t.ef,s=t.eb,l=t.l,h=t.dq,o=t.dP,u=t.c3,_=t.aq,f=t.z,c=t.G,g=t.aH,p=t.b3,d=t.x,y=t.dh,b=t.a3,M=t.c7,v=t.ch,w=t.dm,m=t.fI,S=t.gl,z=t.gO,k=t.ej,C=t.dp,A=t.d5,x=t.fX,I=t.gA,E=t.c$,L=t.et,R=t.eg,N=t.cf,T=t.eh,B=t.dG,P=t.c_,O=t.fY,U=t.gn,H=t.ec,D=t.dN,V=t.gv},function(t){X=t.d},function(t){F=t.i},function(){},function(){},function(){},function(t){j=t.R},function(){},function(e){W=e.a,G=e.b,Y=e.c,q=e.T,K=e.d,Z=e.e,$=e.f,J=e.g,Q=e.h,tt=e.i,et=e.j,it=e.k;var i={};i.TERRAIN_BLOCK_TILE_COMPLEXITY=e.b,i.TERRAIN_BLOCK_VERTEX_COMPLEXITY=e.a,i.TERRAIN_BLOCK_VERTEX_SIZE=e.c,i.TERRAIN_DATA_VERSION=e.q,i.TERRAIN_DATA_VERSION2=e.r,i.TERRAIN_DATA_VERSION3=e.s,i.TERRAIN_DATA_VERSION4=e.t,i.TERRAIN_DATA_VERSION5=e.j,i.TERRAIN_DATA_VERSION_DEFAULT=e.u,i.TERRAIN_EAST_INDEX=e.p,i.TERRAIN_HEIGHT_BASE=e.g,i.TERRAIN_HEIGHT_FACTORY=e.h,i.TERRAIN_HEIGHT_FMAX=e.e,i.TERRAIN_HEIGHT_FMIN=e.f,i.TERRAIN_MAX_BLEND_LAYERS=e.i,i.TERRAIN_MAX_LAYER_COUNT=e.k,i.TERRAIN_MAX_LEVELS=e.l,i.TERRAIN_NORTH_INDEX=e.m,i.TERRAIN_SOUTH_INDEX=e.n,i.TERRAIN_WEST_INDEX=e.o,i.TerrainAsset=e.T,i.TerrainLayerBinaryInfo=e.v,i.TerrainLayerInfo=e.d,t(i)}],execute:function(){t("HeightField",function(){function t(t,e){this.data=new Uint16Array,this.w=0,this.h=0,this.w=t,this.h=e,this.data=new Uint16Array(t*e);for(var i=0;i<t*e;++i)this.data[i]=0}var i=t.prototype;return i.set=function(t,e,i){this.data[e*this.w+t]=i},i.get=function(t,e){return this.data[e*this.w+t]},i.getClamp=function(t,i){return t=e(t,0,this.w-1),i=e(i,0,this.h-1),this.get(t,i)},i.getAt=function(t,i){var r=t,n=i,a=Math.floor(r),s=Math.floor(n),l=a+1,h=s+1,o=r-a,u=n-s;a=e(a,0,this.w-1),s=e(s,0,this.h-1),l=e(l,0,this.w-1),h=e(h,0,this.h-1);var _=this.get(a,s),f=this.get(l,s),c=this.get(a,h),g=this.get(l,h),p=.5*(f+c);return o+u<=1?g=p+(p-_):_=p+(p-g),(_*(1-o)+f*o)*(1-u)+(c*(1-o)+g*o)*u},t}());var rt,nt,at,st,lt,ht,ot,ut,_t,ft,ct,gt,pt,dt,yt,bt,Mt,vt,wt,mt,St,zt,kt,Ct,At,xt,It,Et,Lt,Rt,Nt,Tt,Bt,Pt,Ot,Ut,Ht,Dt,Vt,Xt,Ft,jt,Wt,Gt,Yt=new i,qt=new i,Kt=t("TerrainInfo",r("cc.TerrainInfo")((ot=function(){function t(){R(this,"tileSize",at,this),R(this,"blockCount",st,this),R(this,"weightMapSize",lt,this),R(this,"lightMapSize",ht,this)}return n(t,[{key:"size",get:function(){var t=new N(0,0);return t.width=this.blockCount[0]*G*this.tileSize,t.height=this.blockCount[1]*G*this.tileSize,t}},{key:"tileCount",get:function(){var t=[0,0];return t[0]=this.blockCount[0]*G,t[1]=this.blockCount[1]*G,t}},{key:"vertexCount",get:function(){var t=this.tileCount;return t[0]+=1,t[1]+=1,t}}]),t}(),at=a((nt=ot).prototype,"tileSize",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),st=a(nt.prototype,"blockCount",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),lt=a(nt.prototype,"weightMapSize",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),ht=a(nt.prototype,"lightMapSize",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),rt=nt))||rt),Zt=t("TerrainLayer",r("cc.TerrainLayer")((ft=a((_t=function(){R(this,"detailMap",ft,this),R(this,"normalMap",ct,this),R(this,"tileSize",gt,this),R(this,"metallic",pt,this),R(this,"roughness",dt,this)}).prototype,"detailMap",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ct=a(_t.prototype,"normalMap",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gt=a(_t.prototype,"tileSize",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pt=a(_t.prototype,"metallic",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dt=a(_t.prototype,"roughness",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ut=_t))||ut),$t=function(t){function e(){for(var e,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(e=t.call.apply(t,[this].concat(r))||this)._model=null,e._meshData=null,e._brushMaterial=null,e._currentMaterial=null,e._currentMaterialLayers=0,e}s(e,t);var i=e.prototype;return i.destroy=function(){return null!=this._model&&(l.director.root.destroyModel(this._model),this._model=null),t.prototype.destroy.call(this)},i._destroyModel=function(){null!=this._model&&(l.director.root.destroyModel(this._model),this._model=null)},i._invalidMaterial=function(){if(null!=this._currentMaterial){if(null!==this._brushMaterial&&null!==this._brushMaterial.passes&&this._brushMaterial.passes.length>0)for(var t=this._currentMaterial.passes,e=0;e<t.length;++e)if(t[e]===this._brushMaterial.passes[0]){t.pop();break}this._clearMaterials(),this._currentMaterial=null,null!=this._model&&(this._model.enabled=!1)}},i._updateMaterial=function(t,e){if(null!=this._meshData&&null!=this._model){var i=t.getMaxLayer();null!=this._currentMaterial&&i===this._currentMaterialLayers||(this._currentMaterial=new h,this._currentMaterial.initialize({effectAsset:t.getTerrain().getEffectAsset(),defines:t._getMaterialDefines(i)}),null!==this._brushMaterial&&null!==this._brushMaterial.passes&&this._brushMaterial.passes.length>0&&this._currentMaterial.passes.push(this._brushMaterial.passes[0]),e&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0,this._model.receiveShadow=t.getTerrain().receiveShadow)}},i._onMaterialModified=function(t,e){null!=this._model&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},i._onRebuildPSO=function(t,e){this._model&&this._model.setSubModelMaterial(t,e)},i._clearMaterials=function(){null!=this._model&&this._onMaterialModified(0,null)},i._getBuiltinMaterial=function(){return o.get("missing-material")},e}(j),Jt=t("TerrainBlockLightmapInfo",r("cc.TerrainBlockLightmapInfo")((Mt=a((bt=function(){R(this,"texture",Mt,this),R(this,"UOff",vt,this),R(this,"VOff",wt,this),R(this,"UScale",mt,this),R(this,"VScale",St,this)}).prototype,"texture",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vt=a(bt.prototype,"UOff",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wt=a(bt.prototype,"VOff",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mt=a(bt.prototype,"UScale",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),St=a(bt.prototype,"VScale",[T,L],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yt=bt))||yt),Qt=t("TerrainBlock",function(){function t(t,e,i){this._terrain=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._lightmapInfo=null,this._terrain=t,this._index[0]=e,this._index[1]=i,this._lightmapInfo=t._getLightmapInfo(e,i),this._node=new B,this._node.setParent(this._terrain.node),this._node.hideFlags|=P.Flags.DontSave|P.Flags.HideInHierarchy,this._node.layer=this._terrain.node.layer,this._renderable=this._node.addComponent($t)}var e=t.prototype;return e.build=function(){var t=X.root.device,e=new Float32Array(Y*W*W),r=0;Yt.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),qt.set(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);for(var n=0;n<W;++n)for(var a=0;a<W;++a){var s=this._index[0]*G+a,h=this._index[1]*G+n,o=this._terrain.getPosition(s,h),M=this._terrain.getNormal(s,h),v=new u(a/G,n/G);e[r++]=o.x,e[r++]=o.y,e[r++]=o.z,e[r++]=M.x,e[r++]=M.y,e[r++]=M.z,e[r++]=v.x,e[r++]=v.y,i.min(Yt,Yt,o),i.max(qt,qt,o)}var w=t.createBuffer(new _(f.VERTEX|f.TRANSFER_DST,c.HOST|c.DEVICE,Y*Float32Array.BYTES_PER_ELEMENT*W*W,Y*Float32Array.BYTES_PER_ELEMENT));w.update(e);var m=[new g(p.ATTR_POSITION,d.RGB32F),new g(p.ATTR_NORMAL,d.RGB32F),new g(p.ATTR_TEX_COORD,d.RG32F)];this._renderable._meshData=new y([w],m,b.TRIANGLE_LIST,this._terrain._getSharedIndexBuffer());var S=this._renderable._model=l.director.root.createModel(F);S.createBoundingShape(Yt,qt),S.node=S.transform=this._node,this._renderable._getRenderScene().addModel(S),this._updateWeightMap(),this._updateMaterial(!0)},e.rebuild=function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)},e.destroy=function(){this._renderable._destroyModel(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()},e.update=function(){this._updateMaterial(!1);var t=this._terrain.useNormalMap,e=this._terrain.usePBR,i=function(t){return null!==t?t.detailMap:null},r=function(t){var e=null!==t?t.normalMap:null;return null===e&&(e=l.builtinResMgr.get("normal-texture")),e},n=this._renderable._currentMaterial;if(null!==n){var a=this.getMaxLayer(),s=new M(1,1,1,1),h=new M(1,1,1,1),o=new M(0,0,0,0);if(0===a)if(-1!==this.layers[0]){var u=this._terrain.getLayer(this.layers[0]);null!==u&&(s.x=1/u.tileSize,h.x=u.roughness,o.x=u.metallic),n.setProperty("detailMap0",i(u)),t&&n.setProperty("normalMap0",r(u))}else n.setProperty("detailMap0",l.builtinResMgr.get("default-texture")),t&&n.setProperty("normalMap0",l.builtinResMgr.get("normal-texture"));else if(1===a){var _=this._terrain.getLayer(this.layers[0]),f=this._terrain.getLayer(this.layers[1]);null!==_&&(s.x=1/_.tileSize,h.x=_.roughness,o.x=_.metallic),null!==f&&(s.y=1/f.tileSize,h.y=f.roughness,o.y=f.metallic),n.setProperty("weightMap",this._weightMap),n.setProperty("detailMap0",i(_)),n.setProperty("detailMap1",i(f)),t&&(n.setProperty("normalMap0",r(_)),n.setProperty("normalMap1",r(f)))}else if(2===a){var c=this._terrain.getLayer(this.layers[0]),g=this._terrain.getLayer(this.layers[1]),p=this._terrain.getLayer(this.layers[2]);null!==c&&(s.x=1/c.tileSize,h.x=c.roughness,o.x=c.metallic),null!==g&&(s.y=1/g.tileSize,h.y=g.roughness,o.y=g.metallic),null!==p&&(s.z=1/p.tileSize,h.z=p.roughness,o.z=p.metallic),n.setProperty("weightMap",this._weightMap),n.setProperty("detailMap0",i(c)),n.setProperty("detailMap1",i(g)),n.setProperty("detailMap2",i(p)),t&&(n.setProperty("normalMap0",r(c)),n.setProperty("normalMap1",r(g)),n.setProperty("normalMap2",r(p)))}else if(3===a){var d=this._terrain.getLayer(this.layers[0]),y=this._terrain.getLayer(this.layers[1]),b=this._terrain.getLayer(this.layers[2]),v=this._terrain.getLayer(this.layers[3]);null!==d&&(s.x=1/d.tileSize,h.x=d.roughness,o.x=d.metallic),null!==y&&(s.y=1/y.tileSize,h.y=y.roughness,o.y=y.metallic),null!==b&&(s.z=1/b.tileSize,h.z=b.roughness,o.z=b.metallic),null!==v&&(s.w=1/v.tileSize,h.w=v.roughness,o.w=v.metallic),n.setProperty("weightMap",this._weightMap),n.setProperty("detailMap0",i(d)),n.setProperty("detailMap1",i(y)),n.setProperty("detailMap2",i(b)),n.setProperty("detailMap3",i(v)),t&&(n.setProperty("normalMap0",r(d)),n.setProperty("normalMap1",r(y)),n.setProperty("normalMap2",r(b)),n.setProperty("normalMap3",r(v)))}n.setProperty("UVScale",s),e&&(n.setProperty("roughness",h),n.setProperty("metallic",o)),null!==this.lightmap&&(n.setProperty("lightMap",this.lightmap),n.setProperty("lightMapUVParam",this.lightmapUVParam))}},e.setBrushMaterial=function(t){this._renderable._brushMaterial!==t&&(this._renderable._invalidMaterial(),this._renderable._brushMaterial=t)},e.getTerrain=function(){return this._terrain},e.getIndex=function(){return this._index},e.getRect=function(){var t=new v;return t.x=this._index[0]*G,t.y=this._index[1]*G,t.width=G,t.height=G,t},e.setLayer=function(t,e){this.layers[t]!==e&&(this._terrain.setBlockLayer(this._index[0],this._index[1],t,e),this._renderable._invalidMaterial(),this._updateMaterial(!1))},e.getLayer=function(t){return this.layers[t]},e.getMaxLayer=function(){return this.layers[3]>=0?3:this.layers[2]>=0?2:this.layers[1]>=0?1:0},e._getMaterialDefines=function(t){return{LAYERS:t+1,USE_LIGHTMAP:null!==this.lightmap?1:0,USE_NORMALMAP:this._terrain.useNormalMap?1:0,USE_PBR:this._terrain.usePBR?1:0}},e._invalidMaterial=function(){this._renderable._invalidMaterial()},e._updateMaterial=function(t){this._renderable._updateMaterial(this,t)},e._updateHeight=function(){if(null!=this._renderable._meshData){var t=new Float32Array(Y*W*W),e=0;Yt.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),qt.set(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);for(var r=0;r<W;++r)for(var n=0;n<W;++n){var a=this._index[0]*G+n,s=this._index[1]*G+r,l=this._terrain.getPosition(a,s),h=this._terrain.getNormal(a,s),o=new u(n/W,r/W);t[e++]=l.x,t[e++]=l.y,t[e++]=l.z,t[e++]=h.x,t[e++]=h.y,t[e++]=h.z,t[e++]=o.x,t[e++]=o.y,i.min(Yt,Yt,l),i.max(qt,qt,l)}this._renderable._meshData.vertexBuffers[0].update(t),this._renderable._model.createBoundingShape(Yt,qt),this._renderable._model.updateWorldBound()}},e._updateWeightMap=function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new w,this._weightMap.create(this._terrain.weightMapSize,this._terrain.weightMapSize,m.RGBA8888),this._weightMap.setFilters(S.LINEAR,S.LINEAR),this._weightMap.setWrapMode(z.CLAMP_TO_EDGE,z.CLAMP_TO_EDGE));for(var t=new Uint8Array(this._terrain.weightMapSize*this._terrain.weightMapSize*4),e=0,i=0;i<this._terrain.weightMapSize;++i)for(var r=0;r<this._terrain.weightMapSize;++r){var n=this._index[0]*this._terrain.weightMapSize+r,a=this._index[1]*this._terrain.weightMapSize+i,s=this._terrain.getWeight(n,a);t[4*e+0]=Math.floor(255*s.x),t[4*e+1]=Math.floor(255*s.y),t[4*e+2]=Math.floor(255*s.z),t[4*e+3]=Math.floor(255*s.w),e+=1}this._weightMap.uploadData(t)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)},e._updateLightmap=function(t){this._lightmapInfo=t,this._invalidMaterial()},n(t,[{key:"valid",get:function(){if(null===this._terrain)return!1;for(var t=this._terrain.getBlocks(),e=0;e<t.length;++e)if(t[e]===this)return!0;return!1}},{key:"layers",get:function(){return this._terrain.getBlockLayers(this._index[0],this._index[1])}},{key:"lightmap",get:function(){return this._lightmapInfo?this._lightmapInfo.texture:null}},{key:"lightmapUVParam",get:function(){return null!=this._lightmapInfo?new M(this._lightmapInfo.UOff,this._lightmapInfo.VOff,this._lightmapInfo.UScale,this._lightmapInfo.VScale):new M(0,0,0,0)}}]),t}());t("Terrain",(zt=r("cc.Terrain"),kt=O(),Ct=k(q),At=k(C),xt=U(),It=k(Jt),Et=k(A),Lt=k(A),Rt=k(A),Nt=k(q),Tt=U(),Bt=k(C),Pt=U(),Ot=k(Kt),zt(Ut=kt(Ut=x(Ut=I((Gt=function(t){function r(){var e;e=t.call(this)||this,R(e,"__asset",Dt,H(e)),R(e,"_effectAsset",Vt,H(e)),R(e,"_lightmapInfos",Xt,H(e)),R(e,"_receiveShadow",Ft,H(e)),R(e,"_useNormalmap",jt,H(e)),R(e,"_usePBR",Wt,H(e)),e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._normals=[],e._layerList=[],e._layerBuffer=[],e._blocks=[],e._sharedIndexBuffer=null;for(var i=0;i<it;++i)e._layerList.push(null);return e}s(r,t);var a=r.prototype;return a.build=function(t){return this._tileSize=t.tileSize,this._blockCount[0]=t.blockCount[0],this._blockCount[1]=t.blockCount[1],this._weightMapSize=t.weightMapSize,this._lightMapSize=t.lightMapSize,this._buildImp()},a.rebuild=function(t){for(var e=0;e<this._blocks.length;++e)this._blocks[e].destroy();this._blocks=[],this._rebuildLayerBuffer(t),this._rebuildHeights(t),this._rebuildWeights(t),this._tileSize=t.tileSize,this._blockCount[0]=t.blockCount[0],this._blockCount[1]=t.blockCount[1],this._weightMapSize=t.weightMapSize,this._lightMapSize=t.lightMapSize,this._buildNormals();for(var i=0;i<this._blockCount[1];++i)for(var r=0;r<this._blockCount[0];++r)this._blocks.push(new Qt(this,r,i));for(var n=0;n<this._blocks.length;++n)this._blocks[n].build()},a.importHeightField=function(t,e){for(var i=0,r=0;r<this.vertexCount[1];++r)for(var n=0;n<this.vertexCount[0];++n){var a=n/this.tileCount[0],s=r/this.tileCount[1],l=t.getAt(a*t.w,s*t.h)*e;this._heights[i++]=l}this._buildNormals();for(var h=0;h<this._blocks.length;++h)this._blocks[h]._updateHeight()},a.exportHeightField=function(t,e){for(var i=0,r=0;r<t.h;++r)for(var n=0;n<t.w;++n){var a=n/(t.w-1),s=r/(t.h-1),l=a*this.size.width,h=s*this.size.height,o=this.getHeightAt(l,h);null!=o&&(t.data[i++]=o*e)}},a.exportAsset=function(){var t=new q;t.tileSize=this.tileSize,t.blockCount=this.blockCount,t.lightMapSize=this.lightMapSize,t.weightMapSize=this.weightMapSize,t.heights=this.heights,t.weights=this.weights,t.layerBuffer=new Array(4*this._blocks.length);for(var e=0;e<this._blocks.length;++e)t.layerBuffer[4*e+0]=this._blocks[e].layers[0],t.layerBuffer[4*e+1]=this._blocks[e].layers[1],t.layerBuffer[4*e+2]=this._blocks[e].layers[2],t.layerBuffer[4*e+3]=this._blocks[e].layers[3];for(var i=0;i<this._layerList.length;++i){var r=this._layerList[i];if(r&&r.detailMap&&E(r.detailMap)){var n=new K;n.slot=i,n.tileSize=r.tileSize,n.detailMap=r.detailMap,n.normalMap=r.normalMap,n.metallic=r.metallic,n.roughness=r.roughness,t.layerInfos.push(n)}}return t},a.getEffectAsset=function(){return null===this._effectAsset?l.EffectAsset.get("terrain"):this._effectAsset},a.onLoad=function(){for(var t=l.director.root.device,e=new Uint16Array(G*G*6),i=0,r=0;r<G;++r)for(var n=0;n<G;++n){var a=r*W+n,s=r*W+n+1,h=(r+1)*W+n,o=(r+1)*W+n+1;e[i++]=a,e[i++]=h,e[i++]=s,e[i++]=s,e[i++]=h,e[i++]=o}this._sharedIndexBuffer=t.createBuffer(new _(f.INDEX|f.TRANSFER_DST,c.HOST|c.DEVICE,Uint16Array.BYTES_PER_ELEMENT*G*G*6,Uint16Array.BYTES_PER_ELEMENT)),this._sharedIndexBuffer.update(e)},a.onEnable=function(){0===this._blocks.length&&this._buildImp()},a.onDisable=function(){for(var t=0;t<this._blocks.length;++t)this._blocks[t].destroy();this._blocks=[]},a.onDestroy=function(){for(var t=0;t<this._blocks.length;++t)this._blocks[t].destroy();this._blocks=[];for(var e=0;e<this._layerList.length;++e)this._layerList[e]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()},a.onRestore=function(){this.onDisable(),this.onLoad(),this._buildImp(!0)},a.update=function(){for(var t=0;t<this._blocks.length;++t)this._blocks[t].update()},a.addLayer=function(t){for(var e=0;e<this._layerList.length;++e){var i;if(null===this._layerList[e]||this._layerList[e]&&null===(null===(i=this._layerList[e])||void 0===i?void 0:i.detailMap))return this._layerList[e]=t,e}return-1},a.setLayer=function(t,e){this._layerList[t]=e},a.removeLayer=function(t){this._layerList[t]=null},a.getLayer=function(t){return-1===t?null:this._layerList[t]},a.getPosition=function(t,e){var r=t*this._tileSize,n=e*this._tileSize,a=this.getHeight(t,e);return new i(r,a,n)},a.getHeightField=function(){return this._heights},a.setHeight=function(t,i,r){r=e(r,$,Z),this._heights[i*this.vertexCount[0]+t]=J+r/Q},a.getHeight=function(t,e){return(this._heights[e*this.vertexCount[0]+t]-J)*Q},a.getHeightClamp=function(t,i){return t=e(t,0,this.vertexCount[0]-1),i=e(i,0,this.vertexCount[1]-1),this.getHeight(t,i)},a.getHeightAt=function(t,i){var r=t/this.tileSize,n=i/this.tileSize,a=Math.floor(r),s=Math.floor(n),l=a+1,h=s+1,o=r-a,u=n-s;if(a<0||a>this.vertexCount[0]-1||s<0||s>this.vertexCount[1]-1)return null;a=e(a,0,this.vertexCount[0]-1),s=e(s,0,this.vertexCount[1]-1),l=e(l,0,this.vertexCount[0]-1),h=e(h,0,this.vertexCount[1]-1);var _=this.getHeight(a,s),f=this.getHeight(l,s),c=this.getHeight(a,h),g=this.getHeight(l,h),p=.5*(f+c);return o+u<=1?g=p+(p-_):_=p+(p-g),(_*(1-o)+f*o)*(1-u)+(c*(1-o)+g*o)*u},a._setNormal=function(t,e,i){var r=e*this.vertexCount[0]+t;this._normals[3*r+0]=i.x,this._normals[3*r+1]=i.y,this._normals[3*r+2]=i.z},a.getNormal=function(t,e){var r=e*this.vertexCount[0]+t,n=new i;return n.x=this._normals[3*r+0],n.y=this._normals[3*r+1],n.z=this._normals[3*r+2],n},a.getNormalAt=function(t,r){var n=t/this.tileSize,a=r/this.tileSize,s=Math.floor(n),l=Math.floor(a),h=s+1,o=l+1,u=n-s,_=a-l;if(s<0||s>this.vertexCount[0]-1||l<0||l>this.vertexCount[1]-1)return null;s=e(s,0,this.vertexCount[0]-1),l=e(l,0,this.vertexCount[1]-1),h=e(h,0,this.vertexCount[0]-1),o=e(o,0,this.vertexCount[1]-1);var f=this.getNormal(s,l),c=this.getNormal(h,l),g=this.getNormal(s,o),p=this.getNormal(h,o),d=new i;i.add(d,c,g).multiplyScalar(.5),u+_<=1?(p.set(d),p.subtract(f),p.add(d)):(f.set(d),f.subtract(p),f.add(d));var y=new i,b=new i,M=new i;return i.lerp(y,f,c,u),i.lerp(b,g,p,u),i.lerp(M,y,b,_),M},a.setWeight=function(t,e,i){var r=e*this._weightMapSize*this._blockCount[0]+t;this._weights[4*r+0]=255*i.x,this._weights[4*r+1]=255*i.y,this._weights[4*r+2]=255*i.z,this._weights[4*r+3]=255*i.w},a.getWeight=function(t,e){var i=e*this._weightMapSize*this._blockCount[0]+t,r=new M;return r.x=this._weights[4*i+0]/255,r.y=this._weights[4*i+1]/255,r.z=this._weights[4*i+2]/255,r.w=this._weights[4*i+3]/255,r},a.getWeightAt=function(t,i){var r=this.weightMapSize*this.blockCount[0],n=this.weightMapSize*this.blockCount[1];if(0===r||0===n)return null;var a=t/r,s=i/n,l=Math.floor(a),h=Math.floor(s),o=l+1,u=h+1,_=a-l,f=s-h;if(l<0||l>r-1||h<0||h>n-1)return null;l=e(l,0,r-1),h=e(h,0,n-1),o=e(o,0,r-1),u=e(u,0,n-1);var c=this.getWeight(l,h),g=this.getWeight(o,h),p=this.getWeight(l,u),d=this.getWeight(o,u),y=new M;M.add(y,g,p).multiplyScalar(.5),_+f<=1?(d=new M,M.subtract(d,y,c).add(y)):(c=new M,M.subtract(c,y,d).add(y));var b=new M,v=new M,w=new M;return M.lerp(b,c,g,_),M.lerp(v,p,d,_),M.lerp(w,b,v,f),w},a.getMaxWeightLayerAt=function(t,e){var i=this.weightMapSize*this.blockCount[0],r=this.weightMapSize*this.blockCount[1];if(0===i||0===r)return null;var n=t/i,a=e/r,s=Math.floor(n),l=Math.floor(a);if(s<0||s>i-1||l<0||l>r-1)return null;var h=this.getWeight(s,l),o=Math.floor(t/this.weightMapSize),u=Math.floor(e/this.weightMapSize),_=this.getBlock(o,u),f=0;return h.y>h[f]&&-1!==_.getLayer(1)&&(f=1),h.y>h[f]&&-1!==_.getLayer(2)&&(f=2),h.z>h[f]&&-1!==_.getLayer(3)&&(f=3),f=_.getLayer(f),this.getLayer(f)},a.getBlockLayers=function(t,e){var i=(e*this._blockCount[0]+t)*tt;return[this._layerBuffer[i],this._layerBuffer[i+1],this._layerBuffer[i+2],this._layerBuffer[i+3]]},a.getBlockLayer=function(t,e,i){var r=(e*this._blockCount[0]+t)*tt;return this._layerBuffer[r+i]},a.setBlockLayer=function(t,e,i,r){var n=(e*this._blockCount[0]+t)*tt;this._layerBuffer[n+i]=r},a.getBlock=function(t,e){return this._blocks[e*this._blockCount[0]+t]},a.getBlocks=function(){return this._blocks},a.rayCheck=function(t,e,r,n){void 0===n&&(n=!0);var a=t;n&&i.subtract(a,t,this.node.getWorldPosition());var s=new i;s.set(e),s.multiplyScalar(r);var l=null;if(e.equals(new i(0,1,0))){var h=this.getHeightAt(a.x,a.z);null!=h&&a.y<=h&&(l=new i(a.x,h,a.z))}else if(e.equals(new i(0,-1,0))){var o=this.getHeightAt(a.x,a.z);null!=o&&a.y>=o&&(l=new i(a.x,o,a.z))}else{for(var u=0;u++<2e3;){var _=this.getHeightAt(a.x,a.z);if(null!=_&&a.y<=_)break;a.add(e)}for(;u++<2e3;){var f=this.getHeightAt(a.x,a.z);if(null!=f&&a.y<=f){l=new i(a.x,f,a.z);break}a.add(s)}}return l},a._getSharedIndexBuffer=function(){return this._sharedIndexBuffer},a._resetLightmap=function(t){if(this._lightmapInfos.length=0,t)for(var e=0;e<this._blockCount[0]*this._blockCount[1];++e)this._lightmapInfos.push(new Jt)},a._updateLightmap=function(t,e,i,r,n,a){this._lightmapInfos[t].texture=e,this._lightmapInfos[t].UOff=i,this._lightmapInfos[t].VOff=r,this._lightmapInfos[t].UScale=n,this._lightmapInfos[t].VScale=a,this._blocks[t]._updateLightmap(this._lightmapInfos[t])},a._getLightmapInfo=function(t,e){var i=e*this._blockCount[0]+t;return i<this._lightmapInfos.length?this._lightmapInfos[i]:null},a._calcNormal=function(t,e){var r,n,a=1,s=this.getPosition(t,e);t<this.vertexCount[0]-1?r=this.getPosition(t+1,e):(a*=-1,r=this.getPosition(t-1,e)),e<this.vertexCount[1]-1?n=this.getPosition(t,e+1):(a*=-1,n=this.getPosition(t,e-1)),r.subtract(s),n.subtract(s);var l=new i;return l.set(n),l.cross(r),l.multiplyScalar(a),l.normalize(),l},a._buildNormals=function(){for(var t=0,e=0;e<this.vertexCount[1];++e)for(var i=0;i<this.vertexCount[0];++i){var r=this._calcNormal(i,e);this._normals[3*t+0]=r.x,this._normals[3*t+1]=r.y,this._normals[3*t+2]=r.z,t+=1}},a._buildImp=function(t){var e=this;if(void 0===t&&(t=!1),!this.valid){var i=this.__asset;if(!t&&null!==i){this._tileSize=i.tileSize,this._blockCount=i.blockCount,this._weightMapSize=i.weightMapSize,this._lightMapSize=i.lightMapSize,this._heights=i.heights,this._weights=i.weights,this._layerBuffer=i.layerBuffer;for(var r=0;r<this._layerList.length;++r)this._layerList[r]=null;if(i.version<et)for(var n=function(t){var r=new Zt,n=i.layerBinaryInfos[t];r.tileSize=n.tileSize,l.assetManager.loadAny(n.detailMapId,(function(t,e){r.detailMap=e})),""!==n.normalMapId&&l.assetManager.loadAny(n.normalMapId,(function(t,e){r.normalMap=e})),r.roughness=n.roughness,r.metallic=n.metallic,e._layerList[n.slot]=r},a=0;a<i.layerBinaryInfos.length;++a)n(a);else for(var s=0;s<i.layerInfos.length;++s){var h=new Zt,o=i.layerInfos[s];h.tileSize=o.tileSize,h.detailMap=o.detailMap,h.normalMap=o.normalMap,h.roughness=o.roughness,h.metallic=o.metallic,this._layerList[o.slot]=h}}if(0!==this._blockCount[0]&&0!==this._blockCount[1]){var u=this.vertexCount[0]*this.vertexCount[1];if(null===this._heights||this._heights.length!==u){this._heights=new Uint16Array(u),this._normals=new Array(3*u);for(var _=0;_<u;++_)this._heights[_]=J,this._normals[3*_+0]=0,this._normals[3*_+1]=1,this._normals[3*_+2]=0}else this._normals=new Array(3*u),this._buildNormals();var f=this.blockCount[0]*this.blockCount[1]*tt;if(null===this._layerBuffer||this._layerBuffer.length!==f){this._layerBuffer=new Array(f);for(var c=0;c<f;++c)this._layerBuffer[c]=-1}var g=this._weightMapSize*this._blockCount[0],p=this._weightMapSize*this._blockCount[1];if(this._weights.length!==g*p*4){this._weights=new Uint8Array(g*p*4);for(var d=0;d<g*p;++d)this._weights[4*d+0]=255,this._weights[4*d+1]=0,this._weights[4*d+2]=0,this._weights[4*d+3]=0}for(var y=0;y<this._blockCount[1];++y)for(var b=0;b<this._blockCount[0];++b)this._blocks.push(new Qt(this,b,y));for(var M=0;M<this._blocks.length;++M)this._blocks[M].build()}}},a._rebuildHeights=function(t){if(this.vertexCount[0]===t.vertexCount[0]&&this.vertexCount[1]===t.vertexCount[1])return!1;for(var e=new Uint16Array(t.vertexCount[0]*t.vertexCount[1]),i=0;i<e.length;++i)e[i]=J;for(var r=Math.min(this.vertexCount[0],t.vertexCount[0]),n=Math.min(this.vertexCount[1],t.vertexCount[1]),a=0;a<n;++a)for(var s=0;s<r;++s){var l=a*t.vertexCount[0]+s,h=a*this.vertexCount[0]+s;e[l]=this._heights[h]}return this._heights=e,!0},a._rebuildLayerBuffer=function(t){if(this.blockCount[0]===t.blockCount[0]&&this.blockCount[1]===t.blockCount[1])return!1;var e=[];e.length=t.blockCount[0]*t.blockCount[1]*tt;for(var i=0;i<e.length;++i)e[i]=-1;for(var r=Math.min(this.blockCount[0],t.blockCount[0]),n=Math.min(this.blockCount[1],t.blockCount[1]),a=0;a<n;++a)for(var s=0;s<r;++s)for(var l=a*t.blockCount[0]+s,h=a*this.blockCount[0]+s,o=0;o<tt;++o)e[l*tt+o]=this._layerBuffer[h*tt+o];return this._layerBuffer=e,!0},a._rebuildWeights=function(t){var e=this,i=this._weightMapSize,r=this._weightMapSize*this._blockCount[0],n=this._weightMapSize*this._blockCount[1],a=t.weightMapSize*t.blockCount[0],s=t.weightMapSize*t.blockCount[1];if(a===r&&s===n)return!1;for(var l=new Uint8Array(a*s*4),h=0;h<a*s;++h)l[4*h+0]=255,l[4*h+1]=0,l[4*h+2]=0,l[4*h+3]=0;for(var o=Math.min(t.blockCount[0],this._blockCount[0]),u=Math.min(t.blockCount[1],this._blockCount[1]),_=function(t,e,i){var n=e*r+t,a=new M;return a.x=i[4*n+0]/255,a.y=i[4*n+1]/255,a.z=i[4*n+2]/255,a.w=i[4*n+3]/255,a},f=function(t,i,r,n){var a=Math.floor(t),s=Math.floor(i),l=a+1,h=s+1,o=t-a,u=i-s,f=_(a+r,s+n,e._weights),c=_(l+r,s+n,e._weights),g=_(a+r,h+n,e._weights),p=_(l+r,h+n,e._weights),d=new M;M.add(d,c,g).multiplyScalar(.5),o+u<=1?(p.set(d),p.subtract(f),p.add(d)):(f.set(d),f.subtract(p),f.add(d));var y=new M,b=new M,v=new M;return M.lerp(y,f,c,o),M.lerp(b,g,p,o),M.lerp(v,y,b,u),v},c=0;c<u;++c)for(var g=0;g<o;++g)for(var p=g*i,d=c*i,y=0;y<t.weightMapSize;++y)for(var b=0;b<t.weightMapSize;++b){var v=void 0;v=t.weightMapSize===i?_(b+p,y+d,this._weights):f(b/(t.weightMapSize-1)*(i-1),y/(t.weightMapSize-1)*(i-1),p,d,this._weights);var w=g*t.weightMapSize+b,m=(c*t.weightMapSize+y)*a+w;l[4*m+0]=255*v.x,l[4*m+1]=255*v.y,l[4*m+2]=255*v.z,l[4*m+3]=255*v.w}return this._weights=l,!0},n(r,[{key:"_asset",get:function(){return this.__asset},set:function(t){if(this.__asset!==t&&(this.__asset=t,null!=this.__asset&&this.valid)){for(var e=0;e<this._blocks.length;++e)this._blocks[e].destroy();this._blocks=[],this._buildImp()}}},{key:"effectAsset",get:function(){return this._effectAsset},set:function(t){if(this._effectAsset!==t){this._effectAsset=t;for(var e=0;e<this._blocks.length;++e)this._blocks[e]._invalidMaterial()}}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t;for(var e=0;e<this._blocks.length;e++)this._blocks[e]._invalidMaterial()}},{key:"useNormalMap",get:function(){return this._useNormalmap},set:function(t){this._useNormalmap=t;for(var e=0;e<this._blocks.length;e++)this._blocks[e]._invalidMaterial()}},{key:"usePBR",get:function(){return this._usePBR},set:function(t){this._usePBR=t;for(var e=0;e<this._blocks.length;e++)this._blocks[e]._invalidMaterial()}},{key:"size",get:function(){var t=new N(0,0);return t.width=this.blockCount[0]*G*this.tileSize,t.height=this.blockCount[1]*G*this.tileSize,t}},{key:"tileSize",get:function(){return this._tileSize}},{key:"tileCount",get:function(){return[this.blockCount[0]*G,this.blockCount[1]*G]}},{key:"vertexCount",get:function(){var t=this.tileCount;return t[0]+=1,t[1]+=1,t}},{key:"blockCount",get:function(){return this._blockCount}},{key:"lightMapSize",get:function(){return this._lightMapSize}},{key:"weightMapSize",get:function(){return this._weightMapSize}},{key:"heights",get:function(){return this._heights}},{key:"weights",get:function(){return this._weights}},{key:"valid",get:function(){return this._blocks.length>0}},{key:"info",get:function(){var t=new Kt;return t.tileSize=this.tileSize,t.blockCount[0]=this.blockCount[0],t.blockCount[1]=this.blockCount[1],t.weightMapSize=this.weightMapSize,t.lightMapSize=this.lightMapSize,t}}]),r}(D),Dt=a((Ht=Gt).prototype,"__asset",[Ct,T,V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vt=a(Ht.prototype,"_effectAsset",[At,T,V,xt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xt=a(Ht.prototype,"_lightmapInfos",[It,T,V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ft=a(Ht.prototype,"_receiveShadow",[Et,T,V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jt=a(Ht.prototype,"_useNormalmap",[Lt,T,V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wt=a(Ht.prototype,"_usePBR",[Rt,T,V],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a(Ht.prototype,"_asset",[Nt,Tt],Object.getOwnPropertyDescriptor(Ht.prototype,"_asset"),Ht.prototype),a(Ht.prototype,"effectAsset",[Bt,Pt],Object.getOwnPropertyDescriptor(Ht.prototype,"effectAsset"),Ht.prototype),a(Ht.prototype,"receiveShadow",[L],Object.getOwnPropertyDescriptor(Ht.prototype,"receiveShadow"),Ht.prototype),a(Ht.prototype,"useNormalMap",[L],Object.getOwnPropertyDescriptor(Ht.prototype,"useNormalMap"),Ht.prototype),a(Ht.prototype,"usePBR",[L],Object.getOwnPropertyDescriptor(Ht.prototype,"usePBR"),Ht.prototype),a(Ht.prototype,"info",[Ot],Object.getOwnPropertyDescriptor(Ht.prototype,"info"),Ht.prototype),Ut=Ht))||Ut)||Ut)||Ut)||Ut))}}}));
