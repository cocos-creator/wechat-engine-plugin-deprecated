System.register(["./json-asset-1f2be75e.js","./index-a996f499.js","./view-368b93a3.js","./texture-buffer-pool-4d3e5972.js","./deprecated-c0e66301.js","./camera-component-4c08f67b.js","./renderable-component-da5e0106.js","./transform-utils-ca30a5c5.js","./index-02fa7793.js","./create-mesh-87c3403d.js","./mesh-03a92ddc.js","./mesh-renderer-251b554d.js","./skeleton-6271b1fe.js"],(function(t){"use strict";var e,i,r,a,n,o,s,l,u,h,c,_,p,d,f,m,y,v,b,g,M,w,S,T,O,x,z,R,E,C,A,D,F,I,P,L,B,U,V,k,N,G,H,W,j,X,K,Y,q,Q,Z,J,$,tt,et,it,rt,at,nt,ot,st,lt,ut,ht,ct,_t,pt,dt,ft,mt,yt,vt,bt,gt,Mt,wt,St,Tt,Ot,xt,zt,Rt,Et,Ct;return{setters:[function(t){e=t.ee,i=t.ej,r=t.dm,a=t.fX,n=t.eb,o=t.a3,s=t.cj,l=t.aH,u=t.b3,h=t.x,c=t.l,_=t.dq,p=t.dP,d=t.e1,f=t.ef,m=t.fY,y=t.fZ,v=t.fT,b=t.eg,g=t.ec,M=t.c7,w=t.cs,S=t.cr,T=t.dN,O=t.eh,x=t.c5,z=t.t,R=t.b4,E=t.aq,C=t.z,A=t.G,D=t.dh,F=t.au,I=t.as,P=t.b8,L=t.cJ,B=t.dT,U=t.cq,V=t.f3,k=t.gN,N=t.et,G=t.dl,H=t.fI,W=t.gl,j=t.gO,X=t.cA,K=t.eQ,Y=t.c3,q=t.ei,Q=t.c9,Z=t.cc,J=t.cw,$=t.ct,tt=t.cu,et=t.cv,it=t.gP,rt=t.ge,at=t.gQ,nt=t.gu,ot=t.cB,st=t.co,lt=t.gn,ut=t.R,ht=t.bO,ct=t.f,_t=t.F,pt=t.P,dt=t.ea,ft=t.gR,mt=t.gm,yt=t.g9,vt=t.f_,bt=t.d2,gt=t.dG,Mt=t.cS,wt=t.eL},function(t){St=t.d,Tt=t.D},function(t){Ot=t.i,xt=t.M,zt=t.o},function(){},function(){},function(){},function(t){Rt=t.R},function(){},function(){},function(t){Et=t.c},function(t){Ct=t.M},function(){},function(){}],execute:function(){var At,Dt,Ft,It,Pt,Lt,Bt,Ut,Vt,kt,Nt,Gt,Ht,Wt,jt,Xt,Kt,Yt,qt,Qt,Zt,Jt,$t,te,ee,ie,re,ae,ne,oe,se,le,ue,he,ce,_e,pe,de,fe,me,ye,ve,be,ge,Me,we,Se,Te,Oe,xe=(At=e("cc.Billboard"),Dt=m(),Ft=y(),It=i(r),Pt=i(r),Lt=v(),Bt=v(),Ut=v(),Vt=v(),Kt=At(kt=Dt(kt=Ft(kt=a((Xt=function(t){function e(){var e;return e=t.call(this)||this,b(e,"_texture",Gt,g(e)),b(e,"_height",Ht,g(e)),b(e,"_width",Wt,g(e)),b(e,"_rotation",jt,g(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new M(1,1,0,0),e}n(e,t);var i=e.prototype;return i.onLoad=function(){this.createModel()},i.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},i.onDisable=function(){this.detachFromScene()},i.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},i.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},i.createModel=function(){this._mesh=Et({primitiveMode:o.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[s.WHITE.r,s.WHITE.g,s.WHITE.b,s.WHITE.a,s.WHITE.r,s.WHITE.g,s.WHITE.b,s.WHITE.a,s.WHITE.r,s.WHITE.g,s.WHITE.b,s.WHITE.a,s.WHITE.r,s.WHITE.g,s.WHITE.b,s.WHITE.a],attributes:[new l(u.ATTR_POSITION,h.RGB32F),new l(u.ATTR_TEX_COORD,h.RG32F),new l(u.ATTR_COLOR,h.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var t=this._model=c.director.root.createModel(Ot,this.node);t.node=t.transform=this.node,null==this._material&&(this._material=new _,this._material.copy(p.get("default-billboard-material"))),t.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},d(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._material&&this._material.setProperty("mainTexture",t)}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._material&&(this._uniform.y=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._material&&(this._uniform.x=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*w(this._rotation))/100},set:function(t){this._rotation=S(t),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),e}(T),Gt=f((Nt=Xt).prototype,"_texture",[It],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(Nt.prototype,"texture",[Pt,Lt],Object.getOwnPropertyDescriptor(Nt.prototype,"texture"),Nt.prototype),Ht=f(Nt.prototype,"_height",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f(Nt.prototype,"height",[Bt],Object.getOwnPropertyDescriptor(Nt.prototype,"height"),Nt.prototype),Wt=f(Nt.prototype,"_width",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f(Nt.prototype,"width",[Ut],Object.getOwnPropertyDescriptor(Nt.prototype,"width"),Nt.prototype),jt=f(Nt.prototype,"_rotation",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f(Nt.prototype,"rotation",[Vt],Object.getOwnPropertyDescriptor(Nt.prototype,"rotation"),Nt.prototype),kt=Nt))||kt)||kt)||kt)||kt,t({Billboard:Kt,BillboardComponent:Kt}),Kt),ze=[new l(u.ATTR_POSITION,h.RGB32F),new l(u.ATTR_TEX_COORD,h.RGBA32F),new l(u.ATTR_TEX_COORD1,h.RGB32F),new l(u.ATTR_COLOR,h.RGBA8,!0)],Re=new x,Ee=new x,Ce=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e.type=xt.LINE,e._capacity=100,e._iaInfo=new F([new I]),e._iaInfoBuffer=e._device.createBuffer(new E(C.INDIRECT,A.HOST|A.DEVICE,P,P)),e}n(e,t);var i=e.prototype;return i.setCapacity=function(t){this._capacity=t,this.createBuffer()},i.createBuffer=function(){this._vertSize=0;for(var t,e=z(ze);!(t=e()).done;){var i=t.value;i.offset=this._vertSize,this._vertSize+=R[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},i.updateMaterial=function(e){this._material=e,t.prototype.setSubModelMaterial.call(this,0,e)},i.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var t=this._device.createBuffer(new E(C.VERTEX|C.TRANSFER_DST,A.HOST|A.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),r=0,a=0;a<this._capacity-1;++a){var n=2*a;i[r++]=n,i[r++]=n+1,i[r++]=n+2,i[r++]=n+3,i[r++]=n+2,i[r++]=n+1}var s=this._device.createBuffer(new E(C.INDEX|C.TRANSFER_DST,A.HOST|A.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return s.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new D([t],ze,o.TRIANGLE_LIST,s,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},i.addLineVertexData=function(t,e,i){if(t.length>1){var r=0;x.subtract(Re,t[1],t[0]),this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=0,this._vdataF32[r++]=e.evaluate(0,1),this._vdataF32[r++]=0,this._vdataF32[r++]=0,this._vdataF32[r++]=Re.x,this._vdataF32[r++]=Re.y,this._vdataF32[r++]=Re.z,this._vdataUint32[r++]=i.evaluate(0,1)._val,this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=1,this._vdataF32[r++]=e.evaluate(0,1),this._vdataF32[r++]=0,this._vdataF32[r++]=1,this._vdataF32[r++]=Re.x,this._vdataF32[r++]=Re.y,this._vdataF32[r++]=Re.z,this._vdataUint32[r++]=i.evaluate(0,1)._val;for(var a=1;a<t.length-1;a++){x.subtract(Re,t[a-1],t[a]),x.subtract(Ee,t[a+1],t[a]),x.subtract(Ee,Ee,Re);var n=a/t.length;this._vdataF32[r++]=t[a].x,this._vdataF32[r++]=t[a].y,this._vdataF32[r++]=t[a].z,this._vdataF32[r++]=0,this._vdataF32[r++]=e.evaluate(n,1),this._vdataF32[r++]=n,this._vdataF32[r++]=0,this._vdataF32[r++]=Ee.x,this._vdataF32[r++]=Ee.y,this._vdataF32[r++]=Ee.z,this._vdataUint32[r++]=i.evaluate(n,1)._val,this._vdataF32[r++]=t[a].x,this._vdataF32[r++]=t[a].y,this._vdataF32[r++]=t[a].z,this._vdataF32[r++]=1,this._vdataF32[r++]=e.evaluate(n,1),this._vdataF32[r++]=n,this._vdataF32[r++]=1,this._vdataF32[r++]=Ee.x,this._vdataF32[r++]=Ee.y,this._vdataF32[r++]=Ee.z,this._vdataUint32[r++]=i.evaluate(n,1)._val}x.subtract(Re,t[t.length-1],t[t.length-2]),this._vdataF32[r++]=t[t.length-1].x,this._vdataF32[r++]=t[t.length-1].y,this._vdataF32[r++]=t[t.length-1].z,this._vdataF32[r++]=0,this._vdataF32[r++]=e.evaluate(1,1),this._vdataF32[r++]=1,this._vdataF32[r++]=0,this._vdataF32[r++]=Re.x,this._vdataF32[r++]=Re.y,this._vdataF32[r++]=Re.z,this._vdataUint32[r++]=i.evaluate(1,1)._val,this._vdataF32[r++]=t[t.length-1].x,this._vdataF32[r++]=t[t.length-1].y,this._vdataF32[r++]=t[t.length-1].z,this._vdataF32[r++]=1,this._vdataF32[r++]=e.evaluate(1,1),this._vdataF32[r++]=1,this._vdataF32[r++]=1,this._vdataF32[r++]=Re.x,this._vdataF32[r++]=Re.y,this._vdataF32[r++]=Re.z,this._vdataUint32[r++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,t.length-1))},i.updateIA=function(t){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo)},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},e}(Ot),Ae=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],De=L({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),Fe=t("CurveRange",(Yt=e("cc.CurveRange"),qt=i(De),Qt=i(B),Zt=i(B),Jt=i(B),Yt((he=ue=function(){function t(){b(this,"mode",ee,this),b(this,"spline",ie,this),b(this,"splineMin",re,this),b(this,"splineMax",ae,this),b(this,"constant",ne,this),b(this,"constantMin",oe,this),b(this,"constantMax",se,this),b(this,"multiplier",le,this),this._curve=new V(this.spline),this._curveMin=new V(this.splineMin),this._curveMax=new V(this.splineMax)}var e=t.prototype;return e.evaluate=function(t,e){switch(this.mode){default:case De.Constant:return this.constant;case De.Curve:return this.spline.evaluate(t)*this.multiplier;case De.TwoCurves:return U(this.splineMin.evaluate(t),this.splineMax.evaluate(t),e)*this.multiplier;case De.TwoConstants:return U(this.constantMin,this.constantMax,e)}},e.getMax=function(){switch(this.mode){default:case De.Constant:return this.constant;case De.Curve:return this.multiplier;case De.TwoConstants:return this.constantMax;case De.TwoCurves:return this.multiplier}},e._onBeforeSerialize=function(){return Ae[this.mode]},d(t,[{key:"curve",get:function(){return this._curve},set:function(t){this._curve=t,this.spline=t._internalCurve}},{key:"curveMin",get:function(){return this._curveMin},set:function(t){this._curveMin=t,this.splineMin=t._internalCurve}},{key:"curveMax",get:function(){return this._curveMax},set:function(t){this._curveMax=t,this.splineMax=t._internalCurve}}]),t}(),ue.Mode=De,ee=f((te=he).prototype,"mode",[qt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return De.Constant}}),ie=f(te.prototype,"spline",[Qt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k()}}),re=f(te.prototype,"splineMin",[Zt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k()}}),ae=f(te.prototype,"splineMax",[Jt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return k()}}),ne=f(te.prototype,"constant",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oe=f(te.prototype,"constantMin",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),se=f(te.prototype,"constantMax",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le=f(te.prototype,"multiplier",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$t=te))||$t));function Ie(t,e,i){switch(t.mode){case De.Constant:return t.constant;case De.Curve:return t.spline.evaluate(e)*t.multiplier;case De.TwoCurves:return 0===i?t.splineMin.evaluate(e)*t.multiplier:t.splineMax.evaluate(e)*t.multiplier;case De.TwoConstants:return 0===i?t.constantMin:t.constantMax;default:return 0}}function Pe(t){switch(t.mode){case De.TwoConstants:case De.TwoCurves:return 2;default:return 1}}function Le(t,e,i){var a=new G({width:e,height:i,_data:t,_compressed:!1,format:H.RGBA32F}),n=new r;return n.setFilters(W.NEAREST,W.NEAREST),n.setMipFilter(W.NONE),n.setWrapMode(j.CLAMP_TO_EDGE,j.CLAMP_TO_EDGE,j.CLAMP_TO_EDGE),n.image=a,n}function Be(t,e,i,r,a){for(var n=Math.max(Pe(e),Pe(i),Pe(r)),o=new Float32Array(t*n*4),s=[e,i,r],l=1/(t-1),u=0;u<n;u++)for(var h=0;h<3;h++)for(var c=s[h],_=0,p=0,d=0;d<t;d++){var f=Ie(c,l*d,u);p=a?f:(_+=f)/(d+1),o[4*d+h]=p}return Le(o,t,n)}var Ue,Ve,ke,Ne,Ge,He,We,je,Xe,Ke,Ye,qe,Qe,Ze,Je,$e,ti,ei,ii,ri,ai,ni,oi,si,li,ui,hi,ci,_i,pi,di,fi,mi,yi,vi,bi,gi,Mi,wi,Si,Ti,Oi,xi,zi,Ri,Ei,Ci,Ai,Di,Fi,Ii,Pi,Li,Bi,Ui=L({Blend:0,Fixed:1}),Vi=(t("ColorKey",e("cc.ColorKey")((pe=f((_e=function(){b(this,"color",pe,this),b(this,"time",de,this)}).prototype,"color",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return s.WHITE.clone()}}),de=f(_e.prototype,"time",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ce=_e))||ce),t("AlphaKey",e("cc.AlphaKey")((ye=f((me=function(){b(this,"alpha",ye,this),b(this,"time",ve,this)}).prototype,"alpha",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ve=f(me.prototype,"time",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fe=me))||fe),t("Gradient",e("cc.Gradient")((Oe=Te=function(){function t(){b(this,"colorKeys",Me,this),b(this,"alphaKeys",we,this),b(this,"mode",Se,this),this._color=void 0,this._color=s.WHITE.clone()}var e=t.prototype;return e.setKeys=function(t,e){this.colorKeys=t,this.alphaKeys=e},e.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(t,e){return t.time-e.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(t,e){return t.time-e.time}))},e.evaluate=function(t){return this.getRGB(t),this._color._set_a_unsafe(this.getAlpha(t)),this._color},e.randomColor=function(){var t=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],e=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(t.color),this._color._set_a_unsafe(e.alpha),this._color},e.getRGB=function(t){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(s.WHITE),this._color);t=X(t,1);for(var e=1;e<this.colorKeys.length;++e){var i=this.colorKeys[e-1].time,r=this.colorKeys[e].time;if(t>=i&&t<r){if(this.mode===Ui.Fixed)return this.colorKeys[e].color;var a=(t-i)/(r-i);return s.lerp(this._color,this.colorKeys[e-1].color,this.colorKeys[e].color,a),this._color}}var n=this.colorKeys.length-1;t<this.colorKeys[0].time?s.lerp(this._color,s.BLACK,this.colorKeys[0].color,t/this.colorKeys[0].time):t>this.colorKeys[n].time&&s.lerp(this._color,this.colorKeys[n].color,s.BLACK,(t-this.colorKeys[n].time)/(1-this.colorKeys[n].time))},e.getAlpha=function(t){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;t=X(t,1);for(var e=1;e<this.alphaKeys.length;++e){var i=this.alphaKeys[e-1].time,r=this.alphaKeys[e].time;if(t>=i&&t<r){if(this.mode===Ui.Fixed)return this.alphaKeys[e].alpha;var a=(t-i)/(r-i);return U(this.alphaKeys[e-1].alpha,this.alphaKeys[e].alpha,a)}}var n=this.alphaKeys.length-1;return t<this.alphaKeys[0].time?U(0,this.alphaKeys[0].alpha,t/this.alphaKeys[0].time):t>this.alphaKeys[n].time?U(this.alphaKeys[n].alpha,0,(t-this.alphaKeys[n].time)/(1-this.alphaKeys[n].time)):void 0},t}(),Te.Mode=Ui,Me=f((ge=Oe).prototype,"colorKeys",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),we=f(ge.prototype,"alphaKeys",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),Se=f(ge.prototype,"mode",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ui.Blend}}),be=ge))||be)),ki=K,Ni=L({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),Gi=t("GradientRange",(Ue=e("cc.GradientRange"),Ve=i(Ni),ke=i(Vi),Ne=i(Vi),Ge=i(Vi),He=i(Ni),Ue((ti=$e=function(){function t(){b(this,"color",Xe,this),b(this,"colorMin",Ke,this),b(this,"colorMax",Ye,this),b(this,"gradient",qe,this),b(this,"gradientMin",Qe,this),b(this,"gradientMax",Ze,this),b(this,"_mode",Je,this),this._color=s.WHITE.clone()}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){case Ni.Color:return this.color;case Ni.TwoColors:return s.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case Ni.RandomColor:return this.gradient.randomColor();case Ni.Gradient:return this.gradient.evaluate(t);case Ni.TwoGradients:return s.lerp(this._color,this.gradientMin.evaluate(t),this.gradientMax.evaluate(t),e),this._color;default:return this.color}},e._onBeforeSerialize=function(){return ki[this._mode]},d(t,[{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),t}(),$e.Mode=Ni,f((je=ti).prototype,"mode",[Ve],Object.getOwnPropertyDescriptor(je.prototype,"mode"),je.prototype),Xe=f(je.prototype,"color",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return s.WHITE.clone()}}),Ke=f(je.prototype,"colorMin",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return s.WHITE.clone()}}),Ye=f(je.prototype,"colorMax",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return s.WHITE.clone()}}),qe=f(je.prototype,"gradient",[ke],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vi}}),Qe=f(je.prototype,"gradientMin",[Ne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vi}}),Ze=f(je.prototype,"gradientMax",[Ge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Vi}}),Je=f(je.prototype,"_mode",[He],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ni.Color}}),We=je))||We));function Hi(t,e,i){switch(t.mode){case Ni.Color:return t.color;case Ni.TwoColors:return 0===i?t.colorMin:t.colorMax;case Ni.RandomColor:return t.gradient.randomColor();case Ni.Gradient:return t.gradient.evaluate(e);case Ni.TwoGradients:return 0===i?t.gradientMin.evaluate(e):t.gradientMax.evaluate(e);default:return t.color}}var Wi={parent:null,owner:null,subModelIdx:0},ji={CC_USE_WORLD_SPACE:!1},Xi=function(e){return t({Line:e,LineComponent:e}),e}((ei=e("cc.Line"),ii=m(),ri=y(),ai=i(r),ni=i(r),oi=q(),si=v(),li=q(),ui=v(),hi=i([x]),ci=i([x]),_i=q(),pi=v(),di=i(Fe),fi=i(Fe),mi=q(),yi=v(),vi=i(Y),bi=q(),gi=v(),Mi=i(Y),wi=q(),Si=v(),Ti=i(Gi),Oi=i(Gi),xi=q(),zi=v(),ei(Ri=ii(Ri=ri(Ri=a((Bi=function(t){function e(){var e;return e=t.call(this)||this,b(e,"_texture",Ci,g(e)),e._material=null,e._materialInstance=null,b(e,"_worldSpace",Ai,g(e)),b(e,"_positions",Di,g(e)),b(e,"_width",Fi,g(e)),b(e,"_tile",Ii,g(e)),b(e,"_offset",Pi,g(e)),b(e,"_color",Li,g(e)),e._model=null,e._tile_offset=new M,e}n(e,t);var i=e.prototype;return i.onLoad=function(){var t=this._model=c.director.root.createModel(Ce);t.node=t.transform=this.node,null===this._material&&(this._material=new _,this._material.copy(p.get("default-trail-material")),ji.CC_USE_WORLD_SPACE=this.worldSpace,Wi.parent=this._material,Wi.subModelIdx=0,this._materialInstance=new zt(Wi),Wi.parent=null,Wi.subModelIdx=0,this._materialInstance.recompileShaders(ji)),t.updateMaterial(this._materialInstance),t.setCapacity(100)},i.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},i.onDisable=function(){this._model&&this._detachFromScene()},i._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},i._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},d(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._materialInstance&&this._materialInstance.setProperty("mainTexture",t)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(t){this._worldSpace=t,this._materialInstance&&(ji.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(ji),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(t){this._positions=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(t){this._tile.set(t),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),e}(T),Ci=f((Ei=Bi).prototype,"_texture",[ai],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(Ei.prototype,"texture",[ni,oi,si],Object.getOwnPropertyDescriptor(Ei.prototype,"texture"),Ei.prototype),Ai=f(Ei.prototype,"_worldSpace",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(Ei.prototype,"worldSpace",[li,ui],Object.getOwnPropertyDescriptor(Ei.prototype,"worldSpace"),Ei.prototype),Di=f(Ei.prototype,"_positions",[hi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),f(Ei.prototype,"positions",[ci,_i,pi],Object.getOwnPropertyDescriptor(Ei.prototype,"positions"),Ei.prototype),Fi=f(Ei.prototype,"_width",[di],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),f(Ei.prototype,"width",[fi,mi,yi],Object.getOwnPropertyDescriptor(Ei.prototype,"width"),Ei.prototype),Ii=f(Ei.prototype,"_tile",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Y(1,1)}}),f(Ei.prototype,"tile",[vi,bi,gi],Object.getOwnPropertyDescriptor(Ei.prototype,"tile"),Ei.prototype),Pi=f(Ei.prototype,"_offset",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Y(0,0)}}),f(Ei.prototype,"offset",[Mi,wi,Si],Object.getOwnPropertyDescriptor(Ei.prototype,"offset"),Ei.prototype),Li=f(Ei.prototype,"_color",[Ti],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi}}),f(Ei.prototype,"color",[Oi,xi,zi],Object.getOwnPropertyDescriptor(Ei.prototype,"color"),Ei.prototype),Ri=Ei))||Ri)||Ri)||Ri)||Ri)),Ki=function(){function t(t){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new x(0,0,0),this.velocity=new x(0,0,0),this.animatedVelocity=new x(0,0,0),this.ultimateVelocity=new x(0,0,0),this.angularVelocity=new x(0,0,0),this.axisOfRotation=new x(0,0,0),this.rotation=new x(0,0,0),this.startEuler=new x(0,0,0),this.startRotation=new Q,this.deltaQuat=new Q,this.deltaMat=new Z,this.localMat=new Z,this.startSize=new x(0,0,0),this.size=new x(0,0,0),this.startColor=s.WHITE.clone(),this.color=s.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return t.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},t}();Ki.INDENTIFY_NEG_QUAT=10,Ki.R2D=180/Math.PI;var Yi,qi,Qi,Zi,Ji,$i,tr,er,ir,rr,ar,nr,or,sr,lr,ur,hr,cr,_r,pr,dr,fr,mr,yr,vr,br,gr,Mr,wr,Sr,Tr,Or,xr,zr,Rr="colorModule",Er="rotationModule",Cr="sizeModule",Ar="textureModule",Dr=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],Fr=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],Ir=function(){function t(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var e=t.prototype;return e.bindTarget=function(t){this.target=t},e.update=function(){},t}(),Pr=L({World:0,Local:1,Custom:2}),Lr=L({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),Br=L({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),Ur=L({Base:0,Edge:1,Shell:2,Volume:3}),Vr=L({Random:0,Loop:1,PingPong:2}),kr=L({Particles:0}),Nr=L({Stretch:0}),Gr=(Yi=e("cc.ColorOvertimeModule"),qi=q(),Qi=i(Gi),Zi=q(),Yi((ir=function(t){function e(){for(var e,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return e=t.call.apply(t,[this].concat(r))||this,b(e,"_enable",tr,g(e)),b(e,"color",er,g(e)),e.name=Rr,e}return n(e,t),e.prototype.animate=function(t){t.color.set(t.startColor),t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,J(t.randomSeed+91041)))},d(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Ir),tr=f(($i=ir).prototype,"_enable",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f($i.prototype,"enable",[qi],Object.getOwnPropertyDescriptor($i.prototype,"enable"),$i.prototype),er=f($i.prototype,"color",[Qi,O,Zi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi}}),Ji=$i))||Ji),Hr=new x(0,0,-1);function Wr(t,e,i,r){return e!==t?(t===Pr.World||Z.invert(i,i),Z.getRotation(r,i),!0):(Q.set(r,0,0,0,1),!1)}function jr(t,e){Y.set(t,Math.cos(e),Math.sin(e))}function Xr(t){var e=tt(-1,1),i=tt(0,2*Math.PI),r=Math.sqrt(1-e*e),a=r*Math.cos(i),n=r*Math.sin(i);x.set(t,a,n,e)}function Kr(t,e,i){Xr(t),x.multiplyScalar(t,t,e+(i-e)*$())}function Yr(t,e,i,r){jr(t,r),t.z=0,x.multiplyScalar(t,t,e+(i-e)*$())}function qr(t){for(var e=0;e<t.length;e++){var i=e+et(0,t.length-e),r=t[i];t[i]=t[e],t[e]=r}}function Qr(){var t=tt(-1,1);return 0===t&&t++,it(t)}var Zr,Jr,$r,ta,ea,ia,ra,aa,na,oa,sa,la,ua,ha,ca,_a,pa,da,fa,ma,ya,va,ba,ga,Ma,wa,Sa,Ta,Oa,xa,za,Ra,Ea,Ca,Aa,Da,Fa,Ia,Pa,La,Ba,Ua,Va,ka,Na,Ga,Ha,Wa,ja,Xa,Ka,Ya,qa,Qa,Za,Ja,$a,tn,en,rn,an=212165,nn=new x,on=(rr=e("cc.ForceOvertimeModule"),ar=q(),nr=i(Fe),or=rt(),sr=q(),lr=v(),ur=i(Fe),hr=rt(),cr=q(),_r=v(),pr=i(Fe),dr=rt(),fr=q(),mr=v(),yr=i(Pr),vr=q(),br=v(),rr((zr=function(t){function e(){var e;return e=t.call(this)||this,b(e,"_enable",wr,g(e)),b(e,"x",Sr,g(e)),b(e,"y",Tr,g(e)),b(e,"z",Or,g(e)),b(e,"space",xr,g(e)),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name="forceModule",e.rotation=new Q,e.needTransform=!1,e.needUpdate=!0,e}n(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=Wr(t,this.space,e,this.rotation)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,r=x.set(nn,this.x.evaluate(i,J(t.randomSeed+an)),this.y.evaluate(i,J(t.randomSeed+an)),this.z.evaluate(i,J(t.randomSeed+an)));this.needTransform&&x.transformQuat(r,r,this.rotation),x.scaleAndAdd(t.velocity,t.velocity,r,e),x.copy(t.ultimateVelocity,t.velocity)},d(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Ir),wr=f((Mr=zr).prototype,"_enable",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(Mr.prototype,"enable",[ar],Object.getOwnPropertyDescriptor(Mr.prototype,"enable"),Mr.prototype),Sr=f(Mr.prototype,"x",[nr,O,or,sr,lr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Tr=f(Mr.prototype,"y",[ur,O,hr,cr,_r],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Or=f(Mr.prototype,"z",[pr,O,dr,fr,mr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),xr=f(Mr.prototype,"space",[yr,O,vr,br],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pr.Local}}),gr=Mr))||gr),sn=23541,ln=new x,un=new x,hn=(Zr=e("cc.LimitVelocityOvertimeModule"),Jr=q(),$r=i(Fe),ta=rt(),ea=q(),ia=v(),ra=i(Fe),aa=rt(),na=q(),oa=v(),sa=i(Fe),la=rt(),ua=q(),ha=v(),ca=i(Fe),_a=rt(),pa=q(),da=v(),fa=q(),ma=v(),ya=q(),va=v(),ba=i(Pr),ga=q(),Ma=v(),Zr((Da=function(t){function e(){var e;return e=t.call(this)||this,b(e,"_enable",Ta,g(e)),b(e,"limitX",Oa,g(e)),b(e,"limitY",xa,g(e)),b(e,"limitZ",za,g(e)),b(e,"limit",Ra,g(e)),b(e,"dampen",Ea,g(e)),b(e,"separateAxes",Ca,g(e)),b(e,"space",Aa,g(e)),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name="limitModule",e.rotation=void 0,e.needTransform=void 0,e.rotation=new Q,e.needTransform=!1,e.needUpdate=!0,e}n(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=Wr(t,this.space,e,this.rotation)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=ln;this.separateAxes?(x.set(un,this.limitX.evaluate(e,J(t.randomSeed+sn)),this.limitY.evaluate(e,J(t.randomSeed+sn)),this.limitZ.evaluate(e,J(t.randomSeed+sn))),this.needTransform&&x.transformQuat(un,un,this.rotation),x.set(i,cn(t.ultimateVelocity.x,un.x,this.dampen),cn(t.ultimateVelocity.y,un.y,this.dampen),cn(t.ultimateVelocity.z,un.z,this.dampen))):(x.normalize(i,t.ultimateVelocity),x.multiplyScalar(i,i,cn(t.ultimateVelocity.length(),this.limit.evaluate(e,J(t.randomSeed+sn)),this.dampen))),x.copy(t.ultimateVelocity,i)},d(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Ir),Ta=f((Sa=Da).prototype,"_enable",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(Sa.prototype,"enable",[Jr],Object.getOwnPropertyDescriptor(Sa.prototype,"enable"),Sa.prototype),Oa=f(Sa.prototype,"limitX",[$r,O,ta,ea,ia],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),xa=f(Sa.prototype,"limitY",[ra,O,aa,na,oa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),za=f(Sa.prototype,"limitZ",[sa,O,la,ua,ha],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Ra=f(Sa.prototype,"limit",[ca,O,_a,pa,da],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Ea=f(Sa.prototype,"dampen",[O,fa,ma],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),Ca=f(Sa.prototype,"separateAxes",[O,ya,va],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Aa=f(Sa.prototype,"space",[ba,O,ga,Ma],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pr.Local}}),wa=Sa))||wa);function cn(t,e,i){var r=Math.sign(t),a=Math.abs(t);return a>e&&(a=U(a,e,i)),a*r}var _n,pn,dn,fn,mn,yn,vn,bn,gn,Mn,wn,Sn,Tn,On,xn,zn,Rn,En,Cn,An,Dn,Fn,In,Pn,Ln,Bn,Un,Vn,kn,Nn,Gn,Hn,Wn,jn,Xn,Kn,Yn,qn,Qn,Zn,Jn,$n,to,eo,io,ro,ao,no,oo,so,lo,uo,ho,co,_o,po,fo,mo,yo,vo,bo,go,Mo,wo,So,To,Oo,xo,zo,Ro,Eo,Co,Ao,Do,Fo,Io,Po,Lo,Bo,Uo,Vo,ko,No,Go,Ho,Wo,jo,Xo,Ko,Yo,qo,Qo,Zo,Jo,$o,ts,es,is,rs,as,ns,os,ss,ls,us,hs,cs,_s,ps,ds,fs,ms,ys,vs,bs,gs,Ms,ws,Ss,Ts,Os,xs,zs,Rs,Es,Cs,As,Ds,Fs,Is,Ps,Ls,Bs,Us,Vs,ks,Ns,Gs,Hs,Ws,js,Xs,Ks,Ys,qs,Qs,Zs,Js,$s,tl,el,il,rl,al,nl,ol,sl,ll,ul,hl,cl,_l,pl,dl,fl,ml,yl,vl,bl,gl,Ml,wl=(Fa=e("cc.RotationOvertimeModule"),Ia=q(),Pa=q(),La=v(),Ba=i(Fe),Ua=rt(),Va=q(),ka=v(),Na=i(Fe),Ga=rt(),Ha=q(),Wa=v(),ja=i(Fe),Xa=rt(),Ka=q(),Ya=v(),Fa((rn=function(t){function e(){for(var e,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return e=t.call.apply(t,[this].concat(r))||this,b(e,"_enable",Za,g(e)),b(e,"_separateAxes",Ja,g(e)),b(e,"x",$a,g(e)),b(e,"y",tn,g(e)),b(e,"z",en,g(e)),e.name=Er,e._startMat=new Z,e._matRot=new Z,e._quatRot=new Q,e._otherEuler=new x,e}n(e,t);var i=e.prototype;return i._processRotation=function(t){var e=t.particleSystem.processor.getInfo().renderMode;e!==Lr.Mesh&&e===Lr.StrecthedBillboard&&this._quatRot.set(0,0,0,1),Q.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=Ki.INDENTIFY_NEG_QUAT)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,r=J(t.randomSeed+125292),a=t.particleSystem.processor.getInfo().renderMode;this._separateAxes&&a!==Lr.VerticalBillboard&&a!==Lr.HorizontalBillboard?Q.fromEuler(t.deltaQuat,this.x.evaluate(i,r)*e*Ki.R2D,this.y.evaluate(i,r)*e*Ki.R2D,this.z.evaluate(i,r)*e*Ki.R2D):Q.fromEuler(t.deltaQuat,0,0,this.z.evaluate(i,r)*e*Ki.R2D),t.deltaMat=Z.fromQuat(t.deltaMat,t.deltaQuat),t.localMat=t.localMat.multiply(t.deltaMat),this._startMat=Z.fromQuat(this._startMat,t.startRotation),this._matRot=this._startMat.multiply(t.localMat),Z.getRotation(this._quatRot,this._matRot),this._processRotation(t,Ki.R2D),t.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},d(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(t){this._separateAxes=t}}]),e}(Ir),Za=f((Qa=rn).prototype,"_enable",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(Qa.prototype,"enable",[Ia],Object.getOwnPropertyDescriptor(Qa.prototype,"enable"),Qa.prototype),Ja=f(Qa.prototype,"_separateAxes",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(Qa.prototype,"separateAxes",[Pa,La],Object.getOwnPropertyDescriptor(Qa.prototype,"separateAxes"),Qa.prototype),$a=f(Qa.prototype,"x",[Ba,O,Ua,at,Va,ka],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),tn=f(Qa.prototype,"y",[Na,O,Ga,at,Ha,Wa],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),en=f(Qa.prototype,"z",[ja,O,Xa,at,Ka,Ya],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),qa=Qa))||qa),Sl=(_n=e("cc.SizeOvertimeModule"),pn=q(),dn=q(),fn=v(),mn=i(Fe),yn=q(),vn=v(),bn=i(Fe),gn=q(),Mn=v(),wn=i(Fe),Sn=q(),Tn=v(),On=i(Fe),xn=q(),zn=v(),_n((Ln=function(t){function e(){for(var e,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return e=t.call.apply(t,[this].concat(r))||this,b(e,"_enable",Cn,g(e)),b(e,"separateAxes",An,g(e)),b(e,"size",Dn,g(e)),b(e,"x",Fn,g(e)),b(e,"y",In,g(e)),b(e,"z",Pn,g(e)),e.name=Cr,e}return n(e,t),e.prototype.animate=function(t){if(this.separateAxes){var e=1-t.remainingLifetime/t.startLifetime,i=J(t.randomSeed+39825);t.size.x=t.startSize.x*this.x.evaluate(e,i),t.size.y=t.startSize.y*this.y.evaluate(e,i),t.size.z=t.startSize.z*this.z.evaluate(e,i)}else x.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,J(t.randomSeed+39825)))},d(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Ir),Cn=f((En=Ln).prototype,"_enable",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(En.prototype,"enable",[pn],Object.getOwnPropertyDescriptor(En.prototype,"enable"),En.prototype),An=f(En.prototype,"separateAxes",[O,dn,fn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Dn=f(En.prototype,"size",[mn,O,yn,vn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Fn=f(En.prototype,"x",[bn,O,gn,Mn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),In=f(En.prototype,"y",[wn,O,Sn,Tn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Pn=f(En.prototype,"z",[On,O,xn,zn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Rn=En))||Rn),Tl=90794,Ol=L({Grid:0}),xl=L({WholeSheet:0,SingleRow:1}),zl=(Bn=e("cc.TextureAnimationModule"),Un=nt("numTilesX"),Vn=nt("numTilesY"),kn=q(),Nn=i(Ol),Gn=i(Ol),Hn=q(),Wn=v(),jn=q(),Xn=v(),Kn=q(),Yn=v(),qn=i(xl),Qn=q(),Zn=v(),Jn=i(Fe),$n=q(),to=v(),eo=i(Fe),io=q(),ro=v(),ao=q(),no=v(),oo=q(),so=v(),lo=q(),uo=v(),Bn((xo=function(t){function e(){for(var e,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];return e=t.call.apply(t,[this].concat(r))||this,b(e,"_enable",_o,g(e)),b(e,"_numTilesX",po,g(e)),b(e,"_numTilesY",fo,g(e)),b(e,"_mode",mo,g(e)),b(e,"animation",yo,g(e)),b(e,"frameOverTime",vo,g(e)),b(e,"startFrame",bo,g(e)),b(e,"cycleCount",go,g(e)),b(e,"_flipU",Mo,g(e)),b(e,"_flipV",wo,g(e)),b(e,"_uvChannelMask",So,g(e)),b(e,"randomRow",To,g(e)),b(e,"rowIndex",Oo,g(e)),e.name=Ar,e}n(e,t);var i=e.prototype;return i.init=function(t){t.startRow=Math.floor(Math.random()*this.numTilesY)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=this.startFrame.evaluate(e,J(t.randomSeed+Tl))/(this.numTilesX*this.numTilesY);if(this.animation===xl.WholeSheet)t.frameIndex=X(this.cycleCount*(this.frameOverTime.evaluate(e,J(t.randomSeed+Tl))+i),1);else if(this.animation===xl.SingleRow){var r=1/this.numTilesY;if(this.randomRow){var a=X(this.cycleCount*(this.frameOverTime.evaluate(e,J(t.randomSeed+Tl))+i),1),n=t.startRow*r,o=n+r;t.frameIndex=U(n,o,a)}else{var s=this.rowIndex*r,l=s+r;t.frameIndex=U(s,l,X(this.cycleCount*(this.frameOverTime.evaluate(e,J(t.randomSeed+Tl))+i),1))}}},d(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}},{key:"mode",get:function(){return this._mode},set:function(t){t!==Ol.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}(Ir),_o=f((co=xo).prototype,"_enable",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),po=f(co.prototype,"_numTilesX",[Un],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fo=f(co.prototype,"_numTilesY",[Vn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f(co.prototype,"enable",[kn],Object.getOwnPropertyDescriptor(co.prototype,"enable"),co.prototype),mo=f(co.prototype,"_mode",[Nn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ol.Grid}}),f(co.prototype,"mode",[Gn,Hn,Wn],Object.getOwnPropertyDescriptor(co.prototype,"mode"),co.prototype),f(co.prototype,"numTilesX",[jn,Xn],Object.getOwnPropertyDescriptor(co.prototype,"numTilesX"),co.prototype),f(co.prototype,"numTilesY",[Kn,Yn],Object.getOwnPropertyDescriptor(co.prototype,"numTilesY"),co.prototype),yo=f(co.prototype,"animation",[qn,O,Qn,Zn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xl.WholeSheet}}),vo=f(co.prototype,"frameOverTime",[Jn,O,$n,to],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),bo=f(co.prototype,"startFrame",[eo,O,io,ro],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),go=f(co.prototype,"cycleCount",[O,ao,no],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mo=f(co.prototype,"_flipU",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wo=f(co.prototype,"_flipV",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),So=f(co.prototype,"_uvChannelMask",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),To=f(co.prototype,"randomRow",[O,oo,so],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Oo=f(co.prototype,"rowIndex",[O,lo,uo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ho=co))||ho),Rl=197866,El=new x,Cl=(zo=e("cc.VelocityOvertimeModule"),Ro=q(),Eo=i(Fe),Co=q(),Ao=v(),Do=i(Fe),Fo=q(),Io=v(),Po=i(Fe),Lo=q(),Bo=v(),Uo=i(Fe),Vo=q(),ko=v(),No=i(Pr),Go=q(),Ho=v(),zo((Jo=function(t){function e(){var e;return e=t.call(this)||this,b(e,"_enable",Xo,g(e)),b(e,"x",Ko,g(e)),b(e,"y",Yo,g(e)),b(e,"z",qo,g(e)),b(e,"speedModifier",Qo,g(e)),b(e,"space",Zo,g(e)),e.rotation=void 0,e.needTransform=void 0,e.name="velocityModule",e.rotation=new Q,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}n(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=Wr(t,this.space,e,this.rotation)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=x.set(El,this.x.evaluate(e,J(t.randomSeed^Rl)),this.y.evaluate(e,J(156497^t.randomSeed)),this.z.evaluate(e,J(984136^t.randomSeed)));this.needTransform&&x.transformQuat(i,i,this.rotation),x.add(t.animatedVelocity,t.animatedVelocity,i),x.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),x.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,this.speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,J(t.randomSeed+Rl)))},d(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Ir),Xo=f((jo=Jo).prototype,"_enable",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(jo.prototype,"enable",[Ro],Object.getOwnPropertyDescriptor(jo.prototype,"enable"),jo.prototype),Ko=f(jo.prototype,"x",[Eo,O,Co,Ao],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Yo=f(jo.prototype,"y",[Do,O,Fo,Io],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),qo=f(jo.prototype,"z",[Po,O,Lo,Bo],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Qo=f(jo.prototype,"speedModifier",[Uo,O,Vo,ko],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Zo=f(jo.prototype,"space",[No,O,Go,Ho],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pr.Local}}),Wo=jo))||Wo),Al=t("Burst",($o=e("cc.Burst"),ts=i(Fe),$o((ss=function(){function t(){b(this,"_time",rs,this),b(this,"_repeatCount",as,this),b(this,"repeatInterval",ns,this),b(this,"count",os,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var e=t.prototype;return e.update=function(t,e){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var i=X(t._time-t.startDelay.evaluate(0,1),t.duration)-e;i=i>0?i:0;var r=X(t.time-t.startDelay.evaluate(0,1),t.duration);this._curTime>=i&&this._curTime<r&&(t.emit(this.count.evaluate(this._curTime/t.duration,1),e-(r-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},e.getMaxCount=function(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)},d(t,[{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._curTime=t}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t,this._remainingCount=t}}]),t}(),rs=f((is=ss).prototype,"_time",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f(is.prototype,"time",[N],Object.getOwnPropertyDescriptor(is.prototype,"time"),is.prototype),as=f(is.prototype,"_repeatCount",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),f(is.prototype,"repeatCount",[N],Object.getOwnPropertyDescriptor(is.prototype,"repeatCount"),is.prototype),ns=f(is.prototype,"repeatInterval",[O,N],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),os=f(is.prototype,"count",[ts],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),es=is))||es)),Dl=new x(0,0,0),Fl=[],Il=new x(.5,.5,.5),Pl=(ls=e("cc.ShapeModule"),us=q(),hs=v(),cs=q(),_s=v(),ps=q(),ds=v(),fs=q(),ms=v(),ys=q(),vs=v(),bs=q(),gs=i(Br),Ms=nt("shapeType"),ws=q(),Ss=i(Br),Ts=v(),Os=i(Ur),xs=q(),zs=v(),Rs=q(),Es=v(),Cs=q(),As=v(),Ds=q(),Fs=v(),Is=q(),Ps=v(),Ls=q(),Bs=v(),Us=q(),Vs=v(),ks=i(Vr),Ns=q(),Gs=v(),Hs=lt(),Ws=q(),js=v(),Xs=i(Fe),Ks=lt(),Ys=q(),qs=v(),Qs=q(),Zs=v(),Js=q(),$s=v(),ls((Ml=function(){function t(){b(this,"_enable",il,this),b(this,"_shapeType",rl,this),b(this,"emitFrom",al,this),b(this,"alignToDirection",nl,this),b(this,"randomDirectionAmount",ol,this),b(this,"sphericalDirectionAmount",sl,this),b(this,"randomPositionAmount",ll,this),b(this,"radius",ul,this),b(this,"radiusThickness",hl,this),b(this,"arcMode",cl,this),b(this,"arcSpread",_l,this),b(this,"arcSpeed",pl,this),b(this,"length",dl,this),b(this,"boxThickness",fl,this),b(this,"_position",ml,this),b(this,"_rotation",yl,this),b(this,"_scale",vl,this),b(this,"_arc",bl,this),b(this,"_angle",gl,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Z,this.quat=new Q,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var e=t.prototype;return e.onInit=function(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem._time},e.emit=function(t){switch(this.shapeType){case Br.Box:!function(t,e,i,r){switch(t){case Ur.Volume:a=i,n=Il,x.set(a,tt(-n.x,n.x),tt(-n.y,n.y),tt(-n.z,n.z));break;case Ur.Shell:Fl.splice(0,Fl.length),Fl.push(tt(-.5,.5)),Fl.push(tt(-.5,.5)),Fl.push(.5*Qr()),qr(Fl),Ll(Fl,e),x.set(i,Fl[0],Fl[1],Fl[2]);break;case Ur.Edge:Fl.splice(0,Fl.length),Fl.push(tt(-.5,.5)),Fl.push(.5*Qr()),Fl.push(.5*Qr()),qr(Fl),Ll(Fl,e),x.set(i,Fl[0],Fl[1],Fl[2]);break;default:console.warn(t+" is not supported for box emitter.")}var a,n;x.copy(r,Hr)}(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case Br.Circle:e=this.radius,i=this.radiusThickness,r=this.generateArcAngle(),a=t.position,n=t.velocity,Yr(a,e*(1-i),e,r),x.normalize(n,a);break;case Br.Cone:!function(t,e,i,r,a,n,o,s){switch(t){case Ur.Base:Yr(o,e*(1-i),e,r),Y.multiplyScalar(s,o,Math.sin(a)),s.z=-Math.cos(a)*e,x.normalize(s,s),o.z=0;break;case Ur.Shell:jr(o,r),Y.multiplyScalar(s,o,Math.sin(a)),s.z=-Math.cos(a),x.normalize(s,s),Y.multiplyScalar(o,o,e),o.z=0;break;case Ur.Volume:Yr(o,e*(1-i),e,r),Y.multiplyScalar(s,o,Math.sin(a)),s.z=-Math.cos(a)*e,x.normalize(s,s),o.z=0,x.add(o,o,x.multiplyScalar(Dl,s,n*$()/-s.z));break;default:console.warn(t+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case Br.Sphere:!function(t,e,i,r,a){switch(t){case Ur.Volume:Kr(r,e*(1-i),e),x.normalize(a,r);break;case Ur.Shell:Xr(r),x.multiplyScalar(r,r,e),x.normalize(a,r);break;default:console.warn(t+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case Br.Hemisphere:!function(t,e,i,r,a){switch(t){case Ur.Volume:Kr(r,e*(1-i),e),r.z>0&&(r.z*=-1),x.normalize(a,r);break;case Ur.Shell:Xr(r),x.multiplyScalar(r,r,e),r.z>0&&(r.z*=-1),x.normalize(a,r);break;default:console.warn(t+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}var e,i,r,a,n;if(this.randomPositionAmount>0&&(t.position.x+=tt(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=tt(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=tt(-this.randomPositionAmount,this.randomPositionAmount)),x.transformQuat(t.velocity,t.velocity,this.quat),x.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){var o=x.normalize(Dl,t.position);x.lerp(t.velocity,t.velocity,o,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},e.constructMat=function(){Q.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Z.fromRTS(this.mat,this.quat,this._position,this._scale)},e.generateArcAngle=function(){if(this.arcMode===Vr.Random)return tt(0,this._arc);var t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case Vr.Loop:return X(t,this._arc);case Vr.PingPong:return ot(t,this._arc);default:return X(t,this._arc)}},d(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation=t,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(t){this._scale=t,this.constructMat()}},{key:"arc",get:function(){return w(this._arc)},set:function(t){this._arc=S(t)}},{key:"angle",get:function(){return Math.round(100*w(this._angle))/100},set:function(t){this._angle=S(t)}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"shapeType",get:function(){return this._shapeType},set:function(t){switch(this._shapeType=t,this._shapeType){case Br.Box:this.emitFrom===Ur.Base&&(this.emitFrom=Ur.Volume);break;case Br.Cone:this.emitFrom===Ur.Edge&&(this.emitFrom=Ur.Base);break;case Br.Sphere:case Br.Hemisphere:this.emitFrom!==Ur.Base&&this.emitFrom!==Ur.Edge||(this.emitFrom=Ur.Volume)}}}]),t}(),f((el=Ml).prototype,"position",[us,hs],Object.getOwnPropertyDescriptor(el.prototype,"position"),el.prototype),f(el.prototype,"rotation",[cs,_s],Object.getOwnPropertyDescriptor(el.prototype,"rotation"),el.prototype),f(el.prototype,"scale",[ps,ds],Object.getOwnPropertyDescriptor(el.prototype,"scale"),el.prototype),f(el.prototype,"arc",[fs,ms],Object.getOwnPropertyDescriptor(el.prototype,"arc"),el.prototype),f(el.prototype,"angle",[ys,vs],Object.getOwnPropertyDescriptor(el.prototype,"angle"),el.prototype),il=f(el.prototype,"_enable",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(el.prototype,"enable",[bs],Object.getOwnPropertyDescriptor(el.prototype,"enable"),el.prototype),rl=f(el.prototype,"_shapeType",[gs,Ms,ws],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Br.Cone}}),f(el.prototype,"shapeType",[Ss,Ts],Object.getOwnPropertyDescriptor(el.prototype,"shapeType"),el.prototype),al=f(el.prototype,"emitFrom",[Os,O,xs,zs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ur.Volume}}),nl=f(el.prototype,"alignToDirection",[O,Rs,Es],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ol=f(el.prototype,"randomDirectionAmount",[O,Cs,As],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sl=f(el.prototype,"sphericalDirectionAmount",[O,Ds,Fs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ll=f(el.prototype,"randomPositionAmount",[O,Is,Ps],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ul=f(el.prototype,"radius",[O,Ls,Bs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),hl=f(el.prototype,"radiusThickness",[O,Us,Vs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),cl=f(el.prototype,"arcMode",[ks,O,Ns,Gs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vr.Random}}),_l=f(el.prototype,"arcSpread",[Hs,O,Ws,js],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pl=f(el.prototype,"arcSpeed",[Xs,Ks,O,Ys,qs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),dl=f(el.prototype,"length",[O,Qs,Zs],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),fl=f(el.prototype,"boxThickness",[O,Js,$s],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x(0,0,0)}}),ml=f(el.prototype,"_position",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x(0,0,0)}}),yl=f(el.prototype,"_rotation",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x(0,0,0)}}),vl=f(el.prototype,"_scale",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x(1,1,1)}}),bl=f(el.prototype,"_arc",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S(360)}}),gl=f(el.prototype,"_angle",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S(25)}}),tl=el))||tl);function Ll(t,e){e.x>0&&(t[0]+=.5*tt(-e.x,e.x),t[0]=st(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*tt(-e.y,e.y),t[1]=st(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*tt(-e.z,e.z),t[2]=st(t[2],-.5,.5))}var Bl,Ul,Vl,kl,Nl,Gl,Hl,Wl,jl,Xl,Kl,Yl,ql,Ql,Zl,Jl,$l,tu,eu,iu,ru,au,nu,ou,su,lu,uu,hu,cu,_u=[0,0,1,0,0,1,1,1],pu=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertAttrs=void 0,e._vertSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._material=null,e.type=xt.PARTICLE_BATCH,e._capacity=0,e._vertAttrs=null,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=new F([new I]),e._iaInfoBuffer=e._device.createBuffer(new E(C.INDIRECT,A.HOST|A.DEVICE,P,P)),e._subMeshData=null,e._mesh=null,e}n(e,t);var i=e.prototype;return i.setCapacity=function(t){var e=this._capacity!==t;this._capacity=t,this._subMeshData&&e&&this.rebuild()},i.setVertexAttributes=function(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertSize=0;for(var i,r=z(this._vertAttrs);!(i=r()).done;){var a=i.value;a.offset=this._vertSize,this._vertSize+=R[a.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},i.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new E(C.VERTEX|C.TRANSFER_DST,A.HOST|A.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs[this._vertAttrs.findIndex((function(t){return t.name===u.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,u.ATTR_TEX_COORD,e,this._vertSize,i);var r=this._vertAttrs.findIndex((function(t){return t.name===u.ATTR_TEX_COORD3}));if(i=this._vertAttrs[r++].offset,this._mesh.copyAttribute(0,u.ATTR_POSITION,e,this._vertSize,i),i=this._vertAttrs[r++].offset,this._mesh.copyAttribute(0,u.ATTR_NORMAL,e,this._vertSize,i),i=this._vertAttrs[r++].offset,!this._mesh.copyAttribute(0,u.ATTR_COLOR,e,this._vertSize,i))for(var a=new Uint32Array(e),n=0;n<this._vertCount;++n)a[n*this._vertAttrsFloatCount+i/4]=s.WHITE._val;for(var l=new Float32Array(e),h=1;h<this._capacity;h++)l.copyWithin(h*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}t.update(e);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,c);for(var _=1;_<this._capacity;_++)for(var p=0;p<this._indexCount;p++)c[_*this._indexCount+p]=c[p]+_*this._vertCount}else for(var d=0,f=0;f<this._capacity;++f){var m=4*f;c[d++]=m,c[d++]=m+1,c[d++]=m+2,c[d++]=m+3,c[d++]=m+2,c[d++]=m+1}var y=this._device.createBuffer(new E(C.INDEX|C.TRANSFER_DST,A.HOST|A.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return y.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new E(C.INDIRECT,A.HOST|A.DEVICE,P,P))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new D([t],this._vertAttrs,o.TRIANGLE_LIST,y,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},i.updateMaterial=function(t){this._material=t,this.setSubModelMaterial(0,t)},i.addParticleVertexData=function(t,e){if(this._mesh)for(var i=0;i<this._vertCount;i++){var r=(t*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[r++]=e[0].x,this._vdataF32[r++]=e[0].y,this._vdataF32[r++]=e[0].z,r+=2,this._vdataF32[r++]=e[1].z,this._vdataF32[r++]=e[2].x,this._vdataF32[r++]=e[2].y,this._vdataF32[r++]=e[2].z,this._vdataF32[r++]=e[3].x,this._vdataF32[r++]=e[3].y,this._vdataF32[r++]=e[3].z,this._vdataUint32[r++]=e[4]}else{var a=t*this._vertAttrsFloatCount;this._vdataF32[a++]=e[0].x,this._vdataF32[a++]=e[0].y,this._vdataF32[a++]=e[0].z,this._vdataF32[a++]=e[1].x,this._vdataF32[a++]=e[1].y,this._vdataF32[a++]=e[1].z,this._vdataF32[a++]=e[2].x,this._vdataF32[a++]=e[2].y,this._vdataF32[a++]=e[2].z,this._vdataF32[a++]=e[3].x,this._vdataF32[a++]=e[3].y,this._vdataF32[a++]=e[3].z,this._vdataUint32[a++]=e[4],e[5]&&(this._vdataF32[a++]=e[5].x,this._vdataF32[a++]=e[5].y,this._vdataF32[a++]=e[5].z)}},i.addGPUParticleVertexData=function(t,e,i){for(var r=e*this._vertAttrsFloatCount*this._vertCount,a=0;a<this._vertCount;a++){var n=r;this._vdataF32[n++]=t.position.x,this._vdataF32[n++]=t.position.y,this._vdataF32[n++]=t.position.z,this._vdataF32[n++]=i,this._vdataF32[n++]=t.startSize.x,this._vdataF32[n++]=t.startSize.y,this._vdataF32[n++]=t.startSize.z,this._vdataF32[n++]=_u[2*a],this._vdataF32[n++]=t.rotation.x,this._vdataF32[n++]=t.rotation.y,this._vdataF32[n++]=t.rotation.z,this._vdataF32[n++]=_u[2*a+1],this._vdataF32[n++]=t.startColor.r/255,this._vdataF32[n++]=t.startColor.g/255,this._vdataF32[n++]=t.startColor.b/255,this._vdataF32[n++]=t.startColor.a/255,this._vdataF32[n++]=t.velocity.x,this._vdataF32[n++]=t.velocity.y,this._vdataF32[n++]=t.velocity.z,this._vdataF32[n++]=t.startLifetime,this._vdataF32[n++]=t.randomSeed,r+=this._vertAttrsFloatCount}},i.updateGPUParticles=function(t,e,i){for(var r=this._vertAttrsFloatCount*this._vertCount,a=0,n=0,o=0,s=0;s<t;++s)a=s*r,n=this._vdataF32[a+this._startTimeOffset],this._vdataF32[a+this._lifeTimeOffset]-(e-n)<i&&(o=--t*r,this._vdataF32.copyWithin(a,o,o+r),s--);return t},i.constructAttributeIndex=function(){if(this._vertAttrs){var t=this._vertAttrs.findIndex((function(t){return"a_position_starttime"===t.name})),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((function(t){return"a_dir_life"===t.name})),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}},i.updateIA=function(t){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo)},i.clear=function(){this._subModels[0].inputAssembler.indexCount=0},i.destroy=function(){t.prototype.destroy.call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},i.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},e}(Ot),du=function(){function t(t){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=t}var e=t.prototype;return e.getInfo=function(){return this._renderInfo},e.onInit=function(t){this._particleSystem=t},e.onEnable=function(){if(this._particleSystem){this.attachToScene();var t=this._model;t&&(t.node=t.transform=this._particleSystem.node,t.enabled=this._particleSystem.enabledInHierarchy)}},e.onDisable=function(){this.detachFromScene()},e.onDestroy=function(){this._model&&(c.director.root.destroyModel(this._model),this._model=null)},e.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},e.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===Lr.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},e.clear=function(){this._model&&(this._model.enabled=!1)},e._initModel=function(){this._model||(this._model=c.director.root.createModel(pu),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},e.updateTrailMaterial=function(){},e.getDefaultTrailMaterial=function(){return null},t}(),fu=new x,mu=new Z,yu=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],vu=[0,0,1,0,0,1,1,1],bu=[new l(u.ATTR_POSITION,h.RGB32F),new l(u.ATTR_TEX_COORD,h.RGB32F),new l(u.ATTR_TEX_COORD1,h.RGB32F),new l(u.ATTR_TEX_COORD2,h.RGB32F),new l(u.ATTR_COLOR,h.RGBA8,!0)],gu=[new l(u.ATTR_POSITION,h.RGB32F),new l(u.ATTR_TEX_COORD,h.RGB32F),new l(u.ATTR_TEX_COORD1,h.RGB32F),new l(u.ATTR_TEX_COORD2,h.RGB32F),new l(u.ATTR_COLOR,h.RGBA8,!0),new l(u.ATTR_COLOR1,h.RGB32F)],Mu=[new l(u.ATTR_POSITION,h.RGB32F),new l(u.ATTR_TEX_COORD,h.RGB32F),new l(u.ATTR_TEX_COORD1,h.RGB32F),new l(u.ATTR_TEX_COORD2,h.RGB32F),new l(u.ATTR_COLOR,h.RGBA8,!0),new l(u.ATTR_TEX_COORD3,h.RGB32F),new l(u.ATTR_NORMAL,h.RGB32F),new l(u.ATTR_COLOR1,h.RGBA8,!0)],wu={parent:null,owner:null,subModelIdx:0},Su=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._trailDefines=void 0,i._frameTile_velLenScale=void 0,i._tmp_velLenScale=void 0,i._defaultMat=null,i._node_scale=void 0,i._attrs=void 0,i._particles=null,i._defaultTrailMat=null,i._updateList=new Map,i._animateList=new Map,i._runAnimateList=new Array,i._fillDataFunc=null,i._uScaleHandle=0,i._uLenHandle=0,i._inited=!1,i._localMat=new Z,i._gravity=new M,i._model=null,i._frameTile_velLenScale=new M(1,1,0,0),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new M,i._attrs=new Array(5),i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},i._trailDefines={CC_USE_WORLD_SPACE:!0},i}n(e,t);var i=e.prototype;return i.onInit=function(e){var i=this;t.prototype.onInit.call(this,e),this._particles=new ut((function(){return new Ki(i)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},i.clear=function(){t.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},i.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},i.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},i.getDefaultTrailMaterial=function(){return this._defaultTrailMat},i.setNewParticle=function(){},i._initModuleList=function(){var t=this;yu.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var e=0,i=Dr.length;e<i;e++){var r=this._animateList[Dr[e]];r&&this._runAnimateList.push(r)}},i.enableModule=function(t,e,i){e?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[t],delete this._updateList[t]),this._runAnimateList.length=0;for(var r=0,a=Dr.length;r<a;r++){var n=this._animateList[Dr[r]];n&&this._runAnimateList.push(n)}},i.updateParticles=function(t){var e=this,i=this._particleSystem;if(!i)return this._particles.length;switch(i.node.getWorldMatrix(mu),i.scaleSpace){case Pr.Local:i.node.getScale(this._node_scale);break;case Pr.World:i.node.getWorldScale(this._node_scale)}(i.getMaterialInstance(0)||this._defaultMat).passes[0].setUniform(this._uScaleHandle,this._node_scale),this._updateList.forEach((function(t){t.update(i._simulationSpace,mu)}));var r=i._trailModule,a=r&&r.enable;if(a&&r.update(),i.simulationSpace===Pr.Local){var n=i.node.getRotation();Z.fromQuat(this._localMat,n),this._localMat.transpose()}for(var o=function(n){var o=e._particles.data[n];if(o.remainingLifetime-=t,x.set(o.animatedVelocity,0,0,0),o.remainingLifetime<0)return a&&r.removeParticle(o),e._particles.removeAt(n),--n,s=n,"continue";if(i.simulationSpace===Pr.Local){var l=9.8*-i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,J(o.randomSeed))*t;e._gravity.x=0,e._gravity.y=l,e._gravity.z=0,e._gravity.w=1,e._gravity=e._gravity.transformMat4(e._localMat),o.velocity.x+=e._gravity.x,o.velocity.y+=e._gravity.y,o.velocity.z+=e._gravity.z}else o.velocity.y-=9.8*i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,J(o.randomSeed))*t;x.copy(o.ultimateVelocity,o.velocity),e._runAnimateList.forEach((function(e){e.animate(o,t)})),x.scaleAndAdd(o.position,o.position,o.ultimateVelocity,t),a&&r.animate(o,t),s=n},s=0;s<this._particles.length;++s)o(s);return this._model.enabled=this._particles.length>0,this._particles.length},i.updateRenderData=function(){for(var t=0,e=0;e<this._particles.length;++e){var i=this._particles.data[e],r=0,a=this._particleSystem._textureAnimationModule;a&&a.enable&&(r=i.frameIndex),t=4*e,this._fillDataFunc(i,t,r)}},i.beforeRender=function(){this._model.updateIA(this._particles.length)},i.getParticleCount=function(){return this._particles.length},i.onMaterialModified=function(t){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);var i=this._particleSystem._trailModule;i&&i._trailModel&&1===t&&i._trailModel.setSubModelMaterial(0,e)},i._setFillFunc=function(){this._renderInfo.renderMode===Lr.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===Lr.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},i._fillMeshData=function(t,e,i){var r=e/4;this._attrs[0]=t.position,fu.z=i,this._attrs[1]=fu,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._model.addParticleVertexData(r,this._attrs)},i._fillStrecthedData=function(t,e,i){for(var r=0;r<4;++r)this._attrs[0]=t.position,fu.x=vu[2*r],fu.y=vu[2*r+1],fu.z=i,this._attrs[1]=fu,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=t.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(e++,this._attrs)},i._fillNormalData=function(t,e,i){for(var r=0;r<4;++r)this._attrs[0]=t.position,fu.x=vu[2*r],fu.y=vu[2*r+1],fu.z=i,this._attrs[1]=fu,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=null,this._model.addParticleVertexData(e++,this._attrs)},i._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case Lr.StrecthedBillboard:this._vertAttrs=gu.slice();break;case Lr.Mesh:this._vertAttrs=Mu.slice();break;default:this._vertAttrs=bu.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!=e){var i=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1!==i.indexOf("particle")&&-1===i.indexOf("particle-gpu")||t.setMaterial(null,0)}null==t.sharedMaterial&&null==this._defaultMat&&(wu.parent=p.get("default-particle-material"),wu.owner=this._particleSystem,wu.subModelIdx=0,this._defaultMat=new zt(wu),wu.parent=null,wu.owner=null,wu.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var r=t.getMaterialInstance(0)||this._defaultMat;t._simulationSpace===Pr.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var a=r.passes[0];this._uScaleHandle=a.getHandle("scale"),this._uLenHandle=a.getHandle("frameTile_velLenScale");var n=this._renderInfo.renderMode,o=this._frameTile_velLenScale;n===Lr.Billboard?this._defines.CC_RENDER_MODE=0:n===Lr.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,o.z=this._renderInfo.velocityScale,o.w=this._renderInfo.lengthScale):n===Lr.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:n===Lr.VerticalBillboard?this._defines.CC_RENDER_MODE=3:n===Lr.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+n+" not support.");var s=t._textureAnimationModule;s&&s.enable?(M.copy(this._tmp_velLenScale,o),Y.set(this._tmp_velLenScale,s.numTilesX,s.numTilesY),a.setUniform(this._uLenHandle,this._tmp_velLenScale)):a.setUniform(this._uLenHandle,o),r.recompileShaders(this._defines),this._model&&this._model.updateMaterial(r)}},i.updateTrailMaterial=function(){if(this._particleSystem){var t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===Pr.World||e.space===Pr.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var i=t.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(wu.parent=p.get("default-trail-material"),wu.owner=this._particleSystem,wu.subModelIdx=1,this._defaultTrailMat=new zt(wu),wu.parent=null,wu.owner=null,wu.subModelIdx=0),(i=i||this._defaultTrailMat).recompileShaders(this._trailDefines),e.updateMaterial()}}},e}(du),Tu=new Z,Ou=new M,xu=new Q,zu=32,Ru="a_position_starttime",Eu="a_size_uv",Cu="a_rotation_uv",Au="a_color",Du="a_dir_life",Fu="a_rndSeed",Iu=[new l(Ru,h.RGBA32F),new l(Eu,h.RGBA32F),new l(Cu,h.RGBA32F),new l(Au,h.RGBA32F),new l(Du,h.RGBA32F),new l(Fu,h.R32F)],Pu=[new l(Ru,h.RGBA32F),new l(Eu,h.RGBA32F),new l(Cu,h.RGBA32F),new l(Au,h.RGBA32F),new l(Du,h.RGBA32F),new l(Fu,h.R32F),new l(u.ATTR_TEX_COORD,h.RGB32F),new l(u.ATTR_TEX_COORD3,h.RGB32F),new l(u.ATTR_NORMAL,h.RGB32F),new l(u.ATTR_COLOR1,h.RGBA8,!0)],Lu={parent:null,owner:null,subModelIdx:0},Bu=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._frameTile_velLenScale=void 0,i._unifrom_velLenScale=void 0,i._tmp_velLenScale=void 0,i._node_scale=void 0,i._vertAttrs=[],i._defaultMat=null,i._particleNum=0,i._tempParticle=null,i._colorTexture=null,i._forceTexture=null,i._velocityTexture=null,i._rotationTexture=null,i._sizeTexture=null,i._animTexture=null,i._uTimeHandle=0,i._uRotHandle=0,i._inited=!1,i._frameTile_velLenScale=new M(1,1,0,0),i._unifrom_velLenScale=i._frameTile_velLenScale.clone(),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new M,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},i._tempParticle=new Ki(null),i._particleNum=0,i}n(e,t);var i=e.prototype;return i.onInit=function(e){t.prototype.onInit.call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},i.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},i.setVertexAttributes=function(){t.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},i.clear=function(){t.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},i.onDestroy=function(){t.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},i.enableModule=function(){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;t&&(this.initShaderUniform(t),t.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,t))},i.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},i.setNewParticle=function(t){this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem._time),this._particleNum++},i.updateParticles=function(t){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,t),this.updateShaderUniform(t),this._model.enabled=this._particleNum>0,this._particleNum},i.updateRenderData=function(){},i.beforeRender=function(){this._model.updateIA(this._particleNum)},i.updateShaderUniform=function(t){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var i=e.passes[0];Ou.x=this._particleSystem._time,Ou.y=t,i.setUniform(this._uTimeHandle,Ou),this._particleSystem.node.getWorldRotation(xu),i.setUniform(this._uRotHandle,xu)}},i.initShaderUniform=function(t){var e=t.passes[0];this._uTimeHandle=e.getHandle("u_timeDelta"),this._uRotHandle=e.getHandle("u_worldRot"),e.setUniform(e.getHandle("scale"),this._node_scale),e.setUniform(e.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),Ou.x=zu,Ou.y=.03125,e.setUniform(e.getHandle("u_sampleInfo"),Ou);var i=!1,a=this._particleSystem._forceOvertimeModule;if(i=a&&a.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=i,i){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=Be(zu,a.x,a.y,a.z);var n=e.getHandle("force_over_time_tex0"),o=ht.getBindingFromHandle(n);e.bindSampler(o,this._forceTexture.getGFXSampler()),e.bindTexture(o,this._forceTexture.getGFXTexture());var s=e.getHandle("u_force_space");e.setUniform(s,a.space);var l=e.getHandle("u_force_mode");e.setUniform(l,this._forceTexture.height)}var u=this._particleSystem._velocityOvertimeModule;if(i=u&&u.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=i,i){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(t,e,i,r,a){for(var n=Math.max(Pe(e),Pe(i),Pe(r),Pe(a)),o=new Float32Array(128*n),s=[e,i,r,a],l=0;l<n;l++)for(var u=0;u<4;u++)for(var h=s[u],c=0,_=0,p=0;p<32;p++){var d=Ie(h,.03225806451612903*p,l);_=(c+=d)/(p+1),o[4*p+u]=_}return Le(o,32,n)}(0,u.x,u.y,u.z,u.speedModifier);var h=e.getHandle("velocity_over_time_tex0"),c=ht.getBindingFromHandle(h);e.bindSampler(c,this._velocityTexture.getGFXSampler()),e.bindTexture(c,this._velocityTexture.getGFXTexture());var _=e.getHandle("u_velocity_space");e.setUniform(_,u.space);var p=e.getHandle("u_velocity_mode");e.setUniform(p,this._velocityTexture.height)}var d=this._particleSystem._colorOverLifetimeModule;if(i=d&&d.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=i,i){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(t,e){for(var i=function(t){switch(t.mode){case Ni.TwoColors:case Ni.TwoGradients:return 2;default:return 1}}(e),a=new Uint8Array(t*i*4),n=1/(t-1),o=0,s=0;s<i;s++)for(var l=0;l<t;l++){var u=Hi(e,n*l,s);a[o]=u.r,a[o+1]=u.g,a[o+2]=u.b,a[o+3]=u.a,o+=4}var h=new r;return h.create(t,i,H.RGBA8888),h.setFilters(W.LINEAR,W.LINEAR),h.setWrapMode(j.CLAMP_TO_EDGE,j.CLAMP_TO_EDGE),h.uploadData(a),h}(zu,d.color);var f=e.getHandle("color_over_time_tex0"),m=ht.getBindingFromHandle(f);e.bindSampler(m,this._colorTexture.getGFXSampler()),e.bindTexture(m,this._colorTexture.getGFXTexture());var y=e.getHandle("u_color_mode");e.setUniform(y,this._colorTexture.height)}var v=this._particleSystem._rotationOvertimeModule;if(i=v&&v.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=i,i){this._rotationTexture&&this._rotationTexture.destroy(),v.separateAxes?this._rotationTexture=Be(zu,v.x,v.y,v.z):this._rotationTexture=function(t,e){for(var i=Pe(e),r=new Float32Array(128*i),a=0,n=0;n<i;n++)for(var o=0;o<32;o++){var s=Ie(e,.03225806451612903*o,n);r[a+2]=s,a+=4}return Le(r,32,i)}(0,v.z);var b=e.getHandle("rotation_over_time_tex0"),g=ht.getBindingFromHandle(b);e.bindSampler(g,this._rotationTexture.getGFXSampler()),e.bindTexture(g,this._rotationTexture.getGFXTexture());var M=e.getHandle("u_rotation_mode");e.setUniform(M,this._rotationTexture.height)}var w=this._particleSystem._sizeOvertimeModule;if(i=w&&w.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=i,i){this._sizeTexture&&this._sizeTexture.destroy(),w.separateAxes?this._sizeTexture=Be(zu,w.x,w.y,w.z,!0):this._sizeTexture=function(t,e){for(var i=Pe(e),r=new Float32Array(128*i),a=0,n=0,o=0;o<i;o++){0;for(var s=0;s<32;s++){var l=Ie(e,.03225806451612903*s,o);a=l,r[n]=a,r[n+1]=a,r[n+2]=a,n+=4}}return Le(r,32,i)}(0,w.size);var S=e.getHandle("size_over_time_tex0"),T=ht.getBindingFromHandle(S);e.bindSampler(T,this._sizeTexture.getGFXSampler()),e.bindTexture(T,this._sizeTexture.getGFXTexture());var O=e.getHandle("u_size_mode");e.setUniform(O,this._sizeTexture.height)}var x=this._particleSystem._textureAnimationModule;if(i=x&&x.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=i,i){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(t,e,i){for(var r=Math.max(Pe(e),Pe(i)),a=new Float32Array(128*r),n=[e,i],o=0;o<r;o++)for(var s=0;s<2;s++)for(var l=n[s],u=0,h=0,c=0;c<32;c++){var _=Ie(l,.03225806451612903*c,o);h=(u+=_)/(c+1),a[4*c+s]=h}return Le(a,32,r)}(0,x.startFrame,x.frameOverTime);var z=e.getHandle("texture_animation_tex0"),R=ht.getBindingFromHandle(z);e.bindSampler(R,this._animTexture.getGFXSampler()),e.bindTexture(R,this._animTexture.getGFXTexture());var E=e.getHandle("u_anim_info");Ou.x=this._animTexture.height,Ou.y=x.numTilesX*x.numTilesY,Ou.z=x.cycleCount,e.setUniform(E,Ou)}},i.getParticleCount=function(){return this._particleNum},i.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)},i._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case Lr.StrecthedBillboard:this._vertAttrs=Iu.slice();break;case Lr.Mesh:this._vertAttrs=Pu.slice();break;default:this._vertAttrs=Iu.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;if(null!==e){var i=e._effectAsset._name;this._renderInfo.mainTexture=e.getProperty("mainTexture",0),-1===i.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=e.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==t.sharedMaterial&&null==this._defaultMat&&(Lu.parent=p.get("default-particle-gpu-material"),Lu.owner=t,Lu.subModelIdx=0,this._defaultMat=new zt(Lu),Lu.parent=null,Lu.owner=null,Lu.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var r=t.getMaterialInstance(0)||this._defaultMat;switch(t.node.getWorldMatrix(Tu),t.scaleSpace){case Pr.Local:t.node.getScale(this._node_scale);break;case Pr.World:t.node.getWorldScale(this._node_scale)}t._simulationSpace===Pr.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var a=this._renderInfo.renderMode;a===Lr.Billboard?this._defines.CC_RENDER_MODE=0:a===Lr.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):a===Lr.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:a===Lr.VerticalBillboard?this._defines.CC_RENDER_MODE=3:a===Lr.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+a+" not support.");var n=t._textureAnimationModule;n&&n.enable?(Y.set(this._frameTile_velLenScale,n.numTilesX,n.numTilesY),M.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,M.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(r),r.recompileShaders(this._defines),this._model&&this._model.updateMaterial(r)}},e}(du);function Uu(){var t=St.root.device;return!!(t.capabilities.maxVertexTextureUnits>=8&&t.hasFeature(_t.TEXTURE_FLOAT))||(c.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var Vu,ku,Nu,Gu,Hu,Wu,ju,Xu,Ku,Yu,qu,Qu,Zu,Ju,$u,th,eh,ih,rh,ah,nh,oh,sh,lh,uh,hh,ch,_h,ph,dh,fh,mh,yh,vh,bh,gh,Mh,wh,Sh,Th,Oh,xh,zh,Rh,Eh,Ch,Ah,Dh,Fh,Ih,Ph,Lh,Bh,Uh,Vh,kh,Nh,Gh,Hh,Wh,jh,Xh,Kh,Yh,qh,Qh,Zh,Jh,$h,tc,ec,ic,rc,ac,nc,oc,sc,lc,uc,hc,cc,_c,pc,dc,fc,mc,yc,vc,bc,gc,Mc,wc,Sc,Tc,Oc,xc,zc,Rc,Ec,Cc,Ac,Dc,Fc,Ic,Pc,Lc,Bc,Uc,Vc,kc,Nc,Gc,Hc,Wc,jc,Xc,Kc,Yc,qc,Qc,Zc,Jc,$c,t_,e_,i_,r_,a_,n_,o_,s_,l_,u_,h_,c_,__,p_,d_,f_,m_,y_,v_,b_,g_,M_,w_,S_,T_,O_,x_,z_,R_,E_,C_,A_,D_,F_,I_,P_,L_,B_,U_,V_,k_,N_,G_,H_,W_,j_,X_,K_,Y_,q_,Q_,Z_,J_,$_,tp,ep,ip,rp,ap,np,op,sp,lp,up,hp,cp,_p,pp,dp,fp,mp,yp,vp,bp,gp,Mp=(Bl=e("cc.ParticleSystemRenderer"),Ul=i(Lr),Vl=q(),kl=v(),Nl=q(),Gl=v(),Hl=q(),Wl=v(),jl=i(Lr),Xl=i(Ct),Kl=q(),Yl=v(),ql=i(_),Ql=q(),Zl=v(),Jl=i(_),$l=q(),tu=v(),eu=q(),iu=v(),Bl((cu=function(){function t(){b(this,"_renderMode",nu,this),b(this,"_velocityScale",ou,this),b(this,"_lengthScale",su,this),b(this,"_mesh",lu,this),b(this,"_mainTexture",uu,this),b(this,"_useGPU",hu,this),this._particleSystem=null}var e=t.prototype;return e.create=function(t){null===this._particleSystem?this._particleSystem=t:this._particleSystem!==t&&ct(6033)},e.onInit=function(t){if(this.create(t),this._particleSystem.processor)ct(6034);else{var e=this._useGPU&&Uu();this._particleSystem.processor=e?new Bu(this):new Su(this),this._particleSystem.processor.onInit(t)}},e._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new Bu(this):new Su(this),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},d(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(t){this._velocityScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(t){this._lengthScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh=t,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(t){this._mainTexture=t}},{key:"useGPU",get:function(){return this._useGPU},set:function(t){this._useGPU!==t&&(Uu()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}}]),t}(),f((au=cu).prototype,"renderMode",[Ul,Vl,kl],Object.getOwnPropertyDescriptor(au.prototype,"renderMode"),au.prototype),f(au.prototype,"velocityScale",[Nl,Gl],Object.getOwnPropertyDescriptor(au.prototype,"velocityScale"),au.prototype),f(au.prototype,"lengthScale",[Hl,Wl],Object.getOwnPropertyDescriptor(au.prototype,"lengthScale"),au.prototype),nu=f(au.prototype,"_renderMode",[jl,O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lr.Billboard}}),ou=f(au.prototype,"_velocityScale",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),su=f(au.prototype,"_lengthScale",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lu=f(au.prototype,"_mesh",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(au.prototype,"mesh",[Xl,Kl,Yl],Object.getOwnPropertyDescriptor(au.prototype,"mesh"),au.prototype),f(au.prototype,"particleMaterial",[ql,Ql,Zl],Object.getOwnPropertyDescriptor(au.prototype,"particleMaterial"),au.prototype),f(au.prototype,"trailMaterial",[Jl,$l,tu],Object.getOwnPropertyDescriptor(au.prototype,"trailMaterial"),au.prototype),uu=f(au.prototype,"_mainTexture",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hu=f(au.prototype,"_useGPU",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f(au.prototype,"useGPU",[eu,iu],Object.getOwnPropertyDescriptor(au.prototype,"useGPU"),au.prototype),ru=au))||ru),wp=Math.cos(S(100)),Sp={position:new x,velocity:new x},Tp=new Q,Op=new Z,xp=new x,zp=new x,Rp=new s,Ep=function(){function t(t){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new x,lifetime:0,width:0,velocity:new x,direction:0,color:new s})}var e=t.prototype;return e.getElement=function(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])},e.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new x,lifetime:0,width:0,velocity:new x,direction:0,color:new s}),this.start++,this.start%=this.trailElements.length);var t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]},e.iterateElement=function(t,e,i,r){for(var a=this.start>=this.end?this.end+this.trailElements.length:this.end,n=this.start;n<a;n++)e(t,this.trailElements[n%this.trailElements.length],i,r)&&(this.start++,this.start%=this.trailElements.length);this.start===a&&(this.start=-1,this.end=-1)},e.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},e.clear=function(){this.start=-1,this.end=-1},t}(),Cp=(Vu=e("cc.TrailModule"),ku=q(),Nu=i(kr),Gu=q(),Hu=v(),Wu=i(Fe),ju=q(),Xu=v(),Ku=q(),Yu=v(),qu=i(Pr),Qu=q(),Zu=v(),Ju=i(Nr),$u=q(),th=v(),eh=q(),ih=v(),rh=i(Fe),ah=q(),nh=v(),oh=q(),sh=v(),lh=i(Gi),uh=q(),hh=v(),ch=i(Gi),_h=q(),ph=v(),dh=i(Pr),Vu((Ch=function(){function t(){b(this,"_enable",yh,this),b(this,"mode",vh,this),b(this,"lifeTime",bh,this),b(this,"_minParticleDistance",gh,this),b(this,"existWithParticles",Mh,this),b(this,"textureMode",wh,this),b(this,"widthFromParticle",Sh,this),b(this,"widthRatio",Th,this),b(this,"colorFromParticle",Oh,this),b(this,"colorOverTrail",xh,this),b(this,"colorOvertime",zh,this),b(this,"_space",Rh,this),b(this,"_particleSystem",Eh,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new F([new I]),this._vertAttrs=[new l(u.ATTR_POSITION,h.RGB32F),new l(u.ATTR_TEX_COORD,h.RGBA32F),new l(u.ATTR_TEX_COORD1,h.RGB32F),new l(u.ATTR_COLOR,h.RGBA8,!0)],this._vertSize=0;for(var t,e=z(this._vertAttrs);!(t=e()).done;){var i=t.value;this._vertSize+=R[i.format].size}this._particleTrail=new Map}var e=t.prototype;return e.onInit=function(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;for(var e=0,i=t.startLifetime.getMax(),r=t.rateOverTime.getMax(),a=t.duration,n=0,o=t.bursts.length;n<o;n++)e+=t.bursts[n].getMaxCount(t)*Math.ceil(i/a);this._trailNum=Math.ceil(i*this.lifeTime.getMax()*60*(r*a+e)),this._trailSegments=new pt((function(){return new Ep(10)}),Math.ceil(r*a)),this._enable&&(this.enable=this._enable)},e.onEnable=function(){this._attachToScene()},e.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},e._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},e._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},e.destroy=function(){this.destroySubMeshData(),this._trailModel&&(St.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy((function(t){t.trailElements.length=0})),this._trailSegments=null)},e.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},e.clear=function(){if(this.enable){for(var t=this._particleTrail.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},e.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},e.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===Pr.World&&this._particleSystem._simulationSpace===Pr.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(Op),this._particleSystem.node.getWorldRotation(Tp)):this._needTransform=!1},e.animate=function(t,e){if(this._trailSegments)if(t.loopCount>t.lastLoop)t.trailDelay>1?(t.lastLoop=t.loopCount,t.trailDelay=0):t.trailDelay++;else{var i=this._particleTrail.get(t);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(t,i);var r=i.getElement(i.end-1);if(this._needTransform?x.transformMat4(xp,t.position,Op):x.copy(xp,t.position),!(r&&(i.iterateElement(this,this._updateTrailElement,t,e),x.squaredDistance(r.position,xp)<this._minSquaredDistance))&&(r=i.addElement())){x.copy(r.position,xp),r.lifetime=0,this.widthFromParticle?r.width=t.size.x*this.widthRatio.evaluate(0,1):r.width=this.widthRatio.evaluate(0,1);var a=i.count();if(2===a){var n=i.getElement(i.end-2);x.subtract(n.velocity,r.position,n.position)}else if(a>2){var o=i.getElement(i.end-2),s=i.getElement(i.end-3);x.subtract(xp,s.position,o.position),x.subtract(zp,r.position,o.position),x.subtract(o.velocity,zp,xp),x.equals(x.ZERO,o.velocity)&&x.copy(o.velocity,xp),x.normalize(o.velocity,o.velocity),this._checkDirectionReverse(o,s)}this.colorFromParticle?r.color.set(t.color):r.color.set(this.colorOvertime.evaluate(0,1))}}},e.removeParticle=function(t){var e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))},e.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var t,e=z(this._particleTrail.keys());!(t=e()).done;){var i=t.value,r=this._particleTrail.get(i);if(-1!==r.start){var a=4*this.vbOffset/this._vertSize,n=r.start>=r.end?r.end+r.trailElements.length:r.end,o=n-r.start,s=1/o,l=r.trailElements[r.start];this._fillVertexBuffer(l,this.colorOverTrail.evaluate(1,1),a,1,0,4);for(var u=r.start+1;u<n;u++){var h=r.trailElements[u%r.trailElements.length],c=u-r.start;this._fillVertexBuffer(h,this.colorOverTrail.evaluate(1-c/o,1),a,1-c*s,c,5)}this._needTransform?x.transformMat4(Sp.position,i.position,Op):x.copy(Sp.position,i.position);var _=this._trailModel;if(_&&_.node.invalidateChildren(dt.POSITION),1===o||2===o){var p=r.getElement(r.end-1);x.subtract(p.velocity,Sp.position,p.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,x.subtract(Sp.velocity,Sp.position,p.position),this._checkDirectionReverse(Sp,p)}else if(o>2){var d=r.getElement(r.end-1),f=r.getElement(r.end-2);x.subtract(xp,f.position,d.position),x.subtract(zp,Sp.position,d.position),x.normalize(xp,xp),x.normalize(zp,zp),x.subtract(d.velocity,zp,xp),x.normalize(d.velocity,d.velocity),this._checkDirectionReverse(d,f),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(d,this.colorOverTrail.evaluate(s,1),a,s,o-1,5),x.subtract(Sp.velocity,Sp.position,d.position),x.normalize(Sp.velocity,Sp.velocity),this._checkDirectionReverse(Sp,d)}this.widthFromParticle?Sp.width=i.size.x*this.widthRatio.evaluate(0,1):Sp.width=this.widthRatio.evaluate(0,1),Sp.color=i.color,x.equals(Sp.velocity,x.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(Sp,this.colorOverTrail.evaluate(0,1),a,0,o,1)}}this._trailModel.enabled=this.ibOffset>0},e.updateIA=function(t){var e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){var i=e[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=t,this._iaInfoBuffer.update(this._iaInfo)}},e.beforeRender=function(){this.updateIA(this.ibOffset)},e._createModel=function(){this._trailModel||(this._trailModel=c.director.root.createModel(Ot))},e.rebuild=function(){var t=St.root.device,e=t.createBuffer(new E(C.VERTEX|C.TRANSFER_DST,A.HOST|A.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),e.update(i);var r=t.createBuffer(new E(C.INDEX|C.TRANSFER_DST,A.HOST|A.DEVICE,6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*this._trailNum),r.update(this._iBuffer),this._iaInfoBuffer=t.createBuffer(new E(C.INDIRECT,A.HOST|A.DEVICE,P,P)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new D([e],this._vertAttrs,o.TRIANGLE_LIST,r,this._iaInfoBuffer);var a=this._trailModel;a&&(a.node=a.transform=this._particleSystem.node,a.visFlags=this._particleSystem.visibility,a.initSubModel(0,this._subMeshData,this._material),a.enabled=!0)},e._updateTrailElement=function(t,e,i,r){return e.lifetime+=r,t.colorFromParticle?(e.color.set(i.color),e.color.multiply(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),t.widthFromParticle?e.width=i.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime},e._fillVertexBuffer=function(t,e,i,r,a,n){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=r,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,Rp.set(t.color),Rp.multiply(e),this._vbUint32[this.vbOffset++]=Rp._val,this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=r,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=Rp._val,1&n&&(this._iBuffer[this.ibOffset++]=i+2*a,this._iBuffer[this.ibOffset++]=i+2*a-1,this._iBuffer[this.ibOffset++]=i+2*a+1),4&n&&(this._iBuffer[this.ibOffset++]=i+2*a,this._iBuffer[this.ibOffset++]=i+2*a+1,this._iBuffer[this.ibOffset++]=i+2*a+2)},e._checkDirectionReverse=function(t,e){x.dot(t.velocity,e.velocity)<wp?t.direction=1-e.direction:t.direction=e.direction},e.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},d(t,[{key:"enable",get:function(){return this._enable},set:function(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}},{key:"space",get:function(){return this._space},set:function(t){this._space=t;var e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}}]),t}(),f((mh=Ch).prototype,"enable",[ku],Object.getOwnPropertyDescriptor(mh.prototype,"enable"),mh.prototype),yh=f(mh.prototype,"_enable",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vh=f(mh.prototype,"mode",[Nu,O,Gu,Hu],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kr.Particles}}),bh=f(mh.prototype,"lifeTime",[Wu,O,ju,Xu],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),gh=f(mh.prototype,"_minParticleDistance",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),f(mh.prototype,"minParticleDistance",[Ku,Yu],Object.getOwnPropertyDescriptor(mh.prototype,"minParticleDistance"),mh.prototype),f(mh.prototype,"space",[qu,Qu,Zu],Object.getOwnPropertyDescriptor(mh.prototype,"space"),mh.prototype),Mh=f(mh.prototype,"existWithParticles",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wh=f(mh.prototype,"textureMode",[Ju,O,$u,th],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nr.Stretch}}),Sh=f(mh.prototype,"widthFromParticle",[O,eh,ih],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Th=f(mh.prototype,"widthRatio",[rh,O,ah,nh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Oh=f(mh.prototype,"colorFromParticle",[O,oh,sh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xh=f(mh.prototype,"colorOverTrail",[lh,O,uh,hh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi}}),zh=f(mh.prototype,"colorOvertime",[ch,O,_h,ph],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi}}),Rh=f(mh.prototype,"_space",[dh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pr.World}}),Eh=f(mh.prototype,"_particleSystem",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fh=mh))||fh),Ap=new Z,Dp=new Q,Fp=Object.getOwnPropertyDescriptor(Rt.prototype,"sharedMaterials"),Ip=function(e){return t({ParticleSystem:e,ParticleSystemComponent:e}),e}((Ah=e("cc.ParticleSystem"),Dh=m(),Fh=y(),Ih=yt(99),Ph=q(),Lh=v(),Bh=i(Gi),Uh=q(),Vh=v(),kh=i(Pr),Nh=q(),Gh=v(),Hh=q(),Wh=v(),jh=nt("startSize"),Xh=i(Fe),Kh=q(),Yh=v(),qh=i(Fe),Qh=q(),Zh=v(),Jh=i(Fe),$h=q(),tc=v(),ec=i(Fe),ic=q(),rc=v(),ac=q(),nc=v(),oc=i(Fe),sc=q(),lc=v(),uc=i(Fe),hc=q(),cc=v(),_c=i(Fe),pc=nt("startRotation"),dc=q(),fc=v(),mc=i(Fe),yc=q(),vc=v(),bc=i(Fe),gc=q(),Mc=v(),wc=q(),Sc=v(),Tc=q(),Oc=v(),xc=q(),zc=v(),Rc=i(Pr),Ec=q(),Cc=v(),Ac=q(),Dc=v(),Fc=q(),Ic=v(),Pc=i(Fe),Lc=q(),Bc=v(),Uc=i(Fe),Vc=q(),kc=v(),Nc=i(Fe),Gc=q(),Hc=v(),Wc=i([Al]),jc=q(),Xc=v(),Kc=lt(),Yc=i(_),qc=vt(),Qc=i(Gr),Zc=i(Gr),Jc=q(),$c=v(),t_=i(Pl),e_=i(Pl),i_=q(),r_=v(),a_=i(Sl),n_=i(Sl),o_=q(),s_=v(),l_=i(Cl),u_=i(Cl),h_=q(),c_=v(),__=i(on),p_=i(on),d_=q(),f_=v(),m_=i(hn),y_=i(hn),v_=q(),b_=v(),g_=i(wl),M_=i(wl),w_=q(),S_=v(),T_=i(zl),O_=i(zl),x_=q(),z_=v(),R_=i(Cp),E_=i(Cp),C_=q(),A_=v(),D_=i(Mp),F_=q(),I_=v(),P_=q(),L_=v(),Ah(B_=Dh(B_=Fh(B_=Ih(B_=a((gp=function(t){function e(){var e;return e=t.call(this)||this,b(e,"startColor",V_,g(e)),b(e,"scaleSpace",k_,g(e)),b(e,"startSize3D",N_,g(e)),b(e,"startSizeX",G_,g(e)),b(e,"startSizeY",H_,g(e)),b(e,"startSizeZ",W_,g(e)),b(e,"startSpeed",j_,g(e)),b(e,"startRotation3D",X_,g(e)),b(e,"startRotationX",K_,g(e)),b(e,"startRotationY",Y_,g(e)),b(e,"startRotationZ",q_,g(e)),b(e,"startDelay",Q_,g(e)),b(e,"startLifetime",Z_,g(e)),b(e,"duration",J_,g(e)),b(e,"loop",$_,g(e)),b(e,"simulationSpeed",tp,g(e)),b(e,"playOnAwake",ep,g(e)),b(e,"gravityModifier",ip,g(e)),b(e,"rateOverTime",rp,g(e)),b(e,"rateOverDistance",ap,g(e)),b(e,"bursts",np,g(e)),b(e,"_colorOverLifetimeModule",op,g(e)),b(e,"_shapeModule",sp,g(e)),b(e,"_sizeOvertimeModule",lp,g(e)),b(e,"_velocityOvertimeModule",up,g(e)),b(e,"_forceOvertimeModule",hp,g(e)),b(e,"_limitVelocityOvertimeModule",cp,g(e)),b(e,"_rotationOvertimeModule",_p,g(e)),b(e,"_textureAnimationModule",pp,g(e)),b(e,"_trailModule",dp,g(e)),b(e,"renderer",fp,g(e)),b(e,"enableCulling",mp,g(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._needRefresh=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,b(e,"_prewarm",yp,g(e)),b(e,"_capacity",vp,g(e)),b(e,"_simulationSpace",bp,g(e)),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._needRefresh=!0,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new x,e._curWPos=new x,e._customData1=new Y,e._customData2=new Y,e._subEmitters=[],e}n(e,t);var i=e.prototype;return i.onFocusInEditor=function(){this.renderer.create(this)},i.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},i._onMaterialModified=function(t,e){null!==this.processor&&this.processor.onMaterialModified(t,e)},i._onRebuildPSO=function(t,e){this.processor.onRebuildPSO(t,e)},i._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},i._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},i._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()},i.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},i.play=function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play()},i.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},i.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0},i.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear())},i.getParticleCount=function(){return this.processor.getParticleCount()},i.setCustomData1=function(t,e){Y.set(this._customData1,t,e)},i.setCustomData2=function(t,e){Y.set(this._customData2,t,e)},i.onDestroy=function(){c.director.off(c.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy()},i.onEnable=function(){c.director.on(c.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},i.onDisable=function(){c.director.off(c.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable()},i.update=function(t){var e=t*this.simulationSpeed;this._isPlaying&&(this._time+=e,this._emit(e),0!==this.processor.updateParticles(e)||this._isEmitting||this.stop()),this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData()},i.beforeRender=function(){this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())},i._onVisibilityChange=function(t){this.processor._model&&(this.processor._model.visFlags=t)},i._processRotation=function(t){var e=this.processor.getInfo().renderMode;e!==Lr.Mesh&&(e===Lr.StrecthedBillboard?t.startEuler.set(0,0,0):e!==Lr.Billboard&&t.startEuler.set(0,0,t.startEuler.z)),Q.fromEuler(t.startRotation,t.startEuler.x*Ki.R2D,t.startEuler.y*Ki.R2D,t.startEuler.z*Ki.R2D),t.startRotation=Q.normalize(t.startRotation,t.startRotation),t.startRotation.w<0&&(t.startRotation.x+=Ki.INDENTIFY_NEG_QUAT)},i.emit=function(t,e){var i=this._time/this.duration;this._needRefresh&&(this.node.invalidateChildren(dt.POSITION),this._needRefresh=!1),this._simulationSpace===Pr.World&&(this.node.getWorldMatrix(Ap),this.node.getWorldRotation(Dp));for(var r=0;r<t;++r){var a=this.processor.getFreeParticle();if(null===a)return;a.particleSystem=this,a.reset();var n=J(et(0,ft));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(a):(x.set(a.position,0,0,0),x.copy(a.velocity,Hr)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(a);var o=this.startSpeed.evaluate(i,n);if(this.startSpeed.mode===De.Curve){var s=this._time%this.duration;o=this.startSpeed.evaluate(s/this.duration,n)}x.multiplyScalar(a.velocity,a.velocity,o),this._simulationSpace===Pr.World&&(x.transformMat4(a.position,a.position,Ap),x.transformQuat(a.velocity,a.velocity,Dp)),x.copy(a.ultimateVelocity,a.velocity),this.startRotation3D?a.startEuler.set(this.startRotationX.evaluate(i,n),this.startRotationY.evaluate(i,n),this.startRotationZ.evaluate(i,n)):a.startEuler.set(0,0,this.startRotationZ.evaluate(i,n)),this._processRotation(a),x.set(a.rotation,a.startRotation.x,a.startRotation.y,a.startRotation.z),this.startSize3D?x.set(a.startSize,this.startSizeX.evaluate(i,n),this.startSizeY.evaluate(i,n),this.startSizeZ.evaluate(i,n)):(x.set(a.startSize,this.startSizeX.evaluate(i,n),1,1),a.startSize.y=a.startSize.x),x.copy(a.size,a.startSize),a.startColor.set(this.startColor.evaluate(i,n)),a.color.set(a.startColor),a.startLifetime=this.startLifetime.evaluate(i,n)+e,a.remainingLifetime=a.startLifetime,a.randomSeed=et(0,233280),a.loopCount++,this.processor.setNewParticle(a)}},i._prewarmSystem=function(){this.startDelay.mode=De.Constant,this.startDelay.constant=0;for(var t=this.duration/1,e=0;e<t;++e)this._time+=1,this._emit(1),this.processor.updateParticles(1)},i._emit=function(t){var e=this.startDelay.evaluate(0,1);if(this._time>e){if(this._time>this.duration+e&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*t,this._emitRateTimeCounter>1&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,t)}this.node.getWorldPosition(this._curWPos);var r=x.distance(this._curWPos,this._oldWPos);if(x.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=r*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var a=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=a,this.emit(a,t)}for(var n,o=z(this.bursts);!(n=o()).done;)n.value.update(this,t)}},i._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),x.copy(this._curWPos,this._oldWPos)},i.addSubEmitter=function(t){this._subEmitters.push(t)},i.removeSubEmitter=function(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)},i.addBurst=function(t){this.bursts.push(t)},i.removeBurst=function(t){this.bursts.splice(this.bursts.indexOf(t),1)},i._onBeforeSerialize=function(t){var e=this;return this.enableCulling?t.filter((function(t){return!Fr.includes(t)||e[t]&&e[t].enable})):t},d(e,[{key:"capacity",get:function(){return this._capacity},set:function(t){this._capacity=Math.floor(t),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(t){!0===t&&this.loop,this._prewarm=t}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"sharedMaterials",get:function(){return Fp.get.call(this)},set:function(t){Fp.set.call(this,t)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(t){t&&(this._colorOverLifetimeModule=t)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(t){t&&(this._shapeModule=t)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(t){t&&(this._sizeOvertimeModule=t)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(t){t&&(this._velocityOvertimeModule=t)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(t){t&&(this._forceOvertimeModule=t)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(t){t&&(this._limitVelocityOvertimeModule=t)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(t){t&&(this._rotationOvertimeModule=t)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(t){t&&(this._textureAnimationModule=t)}},{key:"trailModule",get:function(){return this._trailModule},set:function(t){t&&(this._trailModule=t)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),e}(Rt),f((U_=gp).prototype,"capacity",[Ph,Lh],Object.getOwnPropertyDescriptor(U_.prototype,"capacity"),U_.prototype),V_=f(U_.prototype,"startColor",[Bh,O,Uh,Vh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gi}}),k_=f(U_.prototype,"scaleSpace",[kh,O,Nh,Gh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pr.Local}}),N_=f(U_.prototype,"startSize3D",[O,Hh,Wh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),G_=f(U_.prototype,"startSizeX",[jh,Xh,Kh,Yh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),H_=f(U_.prototype,"startSizeY",[qh,O,Qh,Zh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),W_=f(U_.prototype,"startSizeZ",[Jh,O,$h,tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),j_=f(U_.prototype,"startSpeed",[ec,O,ic,rc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),X_=f(U_.prototype,"startRotation3D",[O,ac,nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),K_=f(U_.prototype,"startRotationX",[oc,O,at,sc,lc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Y_=f(U_.prototype,"startRotationY",[uc,O,at,hc,cc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),q_=f(U_.prototype,"startRotationZ",[_c,pc,at,dc,fc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Q_=f(U_.prototype,"startDelay",[mc,O,yc,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),Z_=f(U_.prototype,"startLifetime",[bc,O,gc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),J_=f(U_.prototype,"duration",[O,wc,Sc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),$_=f(U_.prototype,"loop",[O,Tc,Oc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),f(U_.prototype,"prewarm",[xc,zc],Object.getOwnPropertyDescriptor(U_.prototype,"prewarm"),U_.prototype),f(U_.prototype,"simulationSpace",[Rc,O,Ec,Cc],Object.getOwnPropertyDescriptor(U_.prototype,"simulationSpace"),U_.prototype),tp=f(U_.prototype,"simulationSpeed",[O,Ac,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ep=f(U_.prototype,"playOnAwake",[O,Fc,Ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ip=f(U_.prototype,"gravityModifier",[Pc,O,Lc,Bc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),rp=f(U_.prototype,"rateOverTime",[Uc,O,Vc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),ap=f(U_.prototype,"rateOverDistance",[Nc,O,Gc,Hc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fe}}),np=f(U_.prototype,"bursts",[Wc,O,jc,Xc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),f(U_.prototype,"sharedMaterials",[mt,Kc,Yc,O,qc],Object.getOwnPropertyDescriptor(U_.prototype,"sharedMaterials"),U_.prototype),op=f(U_.prototype,"_colorOverLifetimeModule",[Qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(U_.prototype,"colorOverLifetimeModule",[Zc,Jc,$c],Object.getOwnPropertyDescriptor(U_.prototype,"colorOverLifetimeModule"),U_.prototype),sp=f(U_.prototype,"_shapeModule",[t_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(U_.prototype,"shapeModule",[e_,i_,r_],Object.getOwnPropertyDescriptor(U_.prototype,"shapeModule"),U_.prototype),lp=f(U_.prototype,"_sizeOvertimeModule",[a_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(U_.prototype,"sizeOvertimeModule",[n_,o_,s_],Object.getOwnPropertyDescriptor(U_.prototype,"sizeOvertimeModule"),U_.prototype),up=f(U_.prototype,"_velocityOvertimeModule",[l_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(U_.prototype,"velocityOvertimeModule",[u_,h_,c_],Object.getOwnPropertyDescriptor(U_.prototype,"velocityOvertimeModule"),U_.prototype),hp=f(U_.prototype,"_forceOvertimeModule",[__],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(U_.prototype,"forceOvertimeModule",[p_,d_,f_],Object.getOwnPropertyDescriptor(U_.prototype,"forceOvertimeModule"),U_.prototype),cp=f(U_.prototype,"_limitVelocityOvertimeModule",[m_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(U_.prototype,"limitVelocityOvertimeModule",[y_,v_,b_],Object.getOwnPropertyDescriptor(U_.prototype,"limitVelocityOvertimeModule"),U_.prototype),_p=f(U_.prototype,"_rotationOvertimeModule",[g_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(U_.prototype,"rotationOvertimeModule",[M_,w_,S_],Object.getOwnPropertyDescriptor(U_.prototype,"rotationOvertimeModule"),U_.prototype),pp=f(U_.prototype,"_textureAnimationModule",[T_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(U_.prototype,"textureAnimationModule",[O_,x_,z_],Object.getOwnPropertyDescriptor(U_.prototype,"textureAnimationModule"),U_.prototype),dp=f(U_.prototype,"_trailModule",[R_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),f(U_.prototype,"trailModule",[E_,C_,A_],Object.getOwnPropertyDescriptor(U_.prototype,"trailModule"),U_.prototype),fp=f(U_.prototype,"renderer",[D_,O,F_,I_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mp}}),mp=f(U_.prototype,"enableCulling",[O,P_,L_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yp=f(U_.prototype,"_prewarm",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vp=f(U_.prototype,"_capacity",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),bp=f(U_.prototype,"_simulationSpace",[O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pr.Local}}),B_=U_))||B_)||B_)||B_)||B_)||B_)),Pp=t("ParticleUtils",function(){function t(){}return t.instantiate=function(t){return this.registeredSceneEvent||(St.on(Tt.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(t._uuid)||this.particleSystemPool.set(t._uuid,new pt((function(){return bt(t)||new gt}),1)),this.particleSystemPool.get(t._uuid).alloc()},t.destroy=function(t){this.particleSystemPool.has(t._prefab.asset._uuid)&&(this.stop(t),this.particleSystemPool.get(t._prefab.asset._uuid).free(t))},t.play=function(t){for(var e,i=z(t.getComponentsInChildren(Ip));!(e=i()).done;)e.value.play()},t.stop=function(t){for(var e,i=z(t.getComponentsInChildren(Ip));!(e=i()).done;)e.value.stop()},t.onSceneUnload=function(){this.particleSystemPool.forEach((function(t){t.destroy((function(t){t.destroy()}))})),this.particleSystemPool.clear()},t}());Pp.particleSystemPool=new Map,Pp.registeredSceneEvent=!1,Mt(Al.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),c.ParticleSystemComponent=Ip,wt.setClassAlias(Ip,"cc.ParticleSystemComponent"),c.BillboardComponent=xe,wt.setClassAlias(xe,"cc.BillboardComponent"),c.LineComponent=Xi,wt.setClassAlias(Xi,"cc.LineComponent"),c.ParticleUtils=Pp}}}));
